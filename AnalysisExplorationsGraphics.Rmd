---
title: "Algumas Análises e Explorações COVID-19"
author: "Mario O. de Menezes"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    fig_height: 6
    fig_width: 8
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, knitr.kable.NA = '', out.width = "90%")
```

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(ggpubr)
library(readxl)
library(knitr)
library(stringi)
library(RColorBrewer)
library(ggthemes)
library(plotly)
library("rvest")
```

# Introdução

A pandemia do novo coronavirus tomou o mundo de assalto. Notícias em todo o lugar dão conta do rápido alastramento do vírus em todo o mundo, e os seus números são alarmantes. 

Para permitir que mais e mais pessoas possam ajudar no combate ao vírus, das mais diversas formas, organizações ao redor do mundo tem disponibilizado dados sobre a evolução da COVID-19 em todo o globo.

Dentre as organizações que disponibilizam dados estão a [European Union Open Data Portal](https://data.europa.eu/euodp/en/home), a [John Hopkins University](https://github.com/CSSEGISandData/2019-nCoV) através de um repositório no GitHub.

Com abundância de dados, me propus a realizar algumas explorações e tabulações destes dados visando entender melhor o cenário mundial.

#### Disclaimer

_Este é um trabalho em andamento; não tem cunho científico e nem pretende que sirva de embasamento para qualquer tomada de decisão. É uma abordagem estritamente pessoal._

<span><a href="https://momenezes.github.io/covid19/"><img src="./back.png" alt="HOME" width="60" style="vertical-align:middle">  <b>HOME  </b> </a></span>


------------

# Base de dados do EU Open Data Portal

Os dados desta seção vieram do [Europe Open Data Portal](https://data.europa.eu/euodp/en/) -- `https://data.europa.eu/euodp/en/`


*2020-03-26:* Houve uma mudança na nomenclatura dos arquivos; a partir da atualização de *25 de Março de 2020* o arquivo não mais tem o sufixo no formato da data, por exemplo, "...`2020-03-24`.xlsx". Assim, algumas partes do código estão sendo mudadas para refletir esta mudança. Não sei se é uma mudança permanente ou alguém esqueceu de colocar o nome correto do arquivo.


```{r}
# alteracoes na nomenclatura dos arquivos e adicao de mais uma coluna (populacao do pais - base 2018 Banco Mundial)
#covid19URLbase <- "https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide-"
covid19URLbase <- "https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide"
hoje <- format(Sys.time(), "%Y-%m-%d")   # vou manter para anexar no nome e saber cada atualização feita.
#hoje <- "2020-03-24"
arqdest <- paste("COVID-19-geographic-distribution-worldwide-",hoje,".xlsx",sep="")
```

<!--
https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide-2020-03-18.xls
https://www.ecdc.europa.eu/sites/default/files/documents/COVID-19-geographic-disbtribution-worldwide.xlsx
-->


```{r eval=FALSE}
# para fazer o download da base; acerte os caminhos e execute este chunk

if (!file.exists(paste("~/datasets/ECDC_Europe",arqdest,sep="/")) || !file.exists(paste("./data",arqdest,sep="/"))) {
  curl::curl_download(paste(covid19URLbase,".xlsx",sep=""), paste("~/datasets/ECDC_Europe",arqdest,sep="/"))
  print(paste("Fazendo download do arquivo", arqdest,sep=":"))
  file.copy(paste("~/datasets/ECDC_Europe",arqdest,sep="/"), paste("./data",arqdest, sep="/"))
} else {
  hoje <- hoje - 1   # vou manter para anexar no nome e saber cada atualização feita.
  arqdest <- paste("COVID-19-geographic-distribution-worldwide-",hoje,".xlsx",sep="")
}
```


```{r leituradados}
covid19 <- read_excel(paste("./data",arqdest,sep="/"))
```

A estrutura dos dados é:

```{r str}
str(covid19)
```

```{r country}
covid19 <- rename(covid19, Country = `countriesAndTerritories`, DateRep = dateRep, Cases = cases, Deaths = deaths, Day = day, Month = month)
```
 


#### Total de Casos pelos dados da EU Open Data Portal: `r format(ymd(hoje) - 1, '%d-%m-%Y')`



```{r}
 covid19 %>% 
  summarise(`Casos no Mundo (EU Open Data Portal)` = sum(Cases)) %>% kable()
```

## Brasil vs Itália

```{r}
Italia <- covid19 %>% 
  filter(Country == "Italy")%>% 
  arrange(DateRep) %>%
  mutate(CumCases = cumsum(Cases))
Brasil <- covid19 %>% 
  filter(Country == "Brazil") %>%
  arrange(DateRep) %>%
  mutate(CumCases = cumsum(Cases))
```

Uma mostra dos últimos 20 dias da Itália.
```{r}
Italia %>% top_n(20, DateRep) %>% kable()
```

O mesmo para o Brasil, últimos 20 dias.
```{r}
Brasil %>% top_n(20, DateRep) %>% kable()
```

```{r}
LimiteCorte <- max(Brasil$CumCases)
```

```{r}
Italia14 <- Italia %>% 
  filter(CumCases >= 14 & CumCases <= LimiteCorte) %>% 
  select(Country,DateRep, Cases,Deaths,CumCases)
Brasil13 <- Brasil %>% 
  filter(CumCases >= 14 & CumCases <= LimiteCorte) %>% 
  select(Country,DateRep,Cases,Deaths,CumCases)
```
```{r}
Italia14 <- mutate(Italia14, Dia = as.numeric(rownames(Italia14)))
Brasil13 <- mutate(Brasil13, Dia = as.numeric(rownames(Brasil13)))
```

```{r eval = FALSE}
Italia14 %>% kable()
```


```{r eval = FALSE}
Brasil13 %>% kable()
```



```{r}
bind_rows(Italia14,Brasil13) %>% ggplot() + geom_point(aes(x = Dia, y = CumCases, color=Country), stat = "identity", position = "dodge") + labs(title = paste("Curva de crescimentos de casos (cumulativo) em número de dias,\n CumCases>=14 & CumCases<=", LimiteCorte," -- Brasil e Itália",sep=""), color = "") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```


```{r}
bind_rows(select(Italia,Country, DateRep, CumCases, Cases, Deaths), select(Brasil, Country, DateRep, CumCases, Cases, Deaths)) %>% filter(DateRep >= "2020-02-22") %>%
   ggplot() + geom_bar(aes(x = DateRep, y = CumCases, fill = Country), stat = "identity", position = "dodge") + 
  labs(y = "Núm de Casos (acum)", x = "Data", title = "Evolução dos Casos na Italia e Brasil, a partir de 22/02/2020", fill = "") + scale_fill_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() # -> g
#fig <- ggplotly(g)
#fig
```


```{r italiagg}
covid19 %>% 
  filter(Country %in% c("Italy", "Brazil"), DateRep > "2020-02-22") %>% 
  arrange(DateRep) %>%
  ggplot() + geom_bar(aes(x = DateRep, y = Cases, fill = Country),  stat = "identity", position = "dodge") + 
  labs(y = "Núm de Casos Reportados (dia)", x = "Data", title = "Número de Casos Reportados diariamente na Italia e Brasil,\n a partir de 22/02/2020", fill = "") + scale_fill_brewer(palette = "Set1") +
  labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```



```{r ccc}
ccc <- read_csv("./data/country-capital-continent.csv")
```

<!--
Os nomes compostos dos países na base de dados do COVID19 utilizam o "_" (_underline_) como separador, por exemplo, `Costa_Rica`. Nas bases de países, regiões e continentes, o separador é o espaço " ". Precisamos ajustar para não termos problemas.
-->

```{r eval=FALSE}
filter(covid19,  grepl("_",covid19$Country)) %>% head()
```



```{r}
# Substituindo o "_" por " " nos nomes dos países
covid19 <- mutate(covid19, Country = str_replace_all(covid19$Country,"_"," "), Country = ifelse(Country == "Eswatini", "Swaziland", Country))
```
```{r}
covid19 <- mutate(covid19, Country = ifelse(Country == "CANADA", "Canada", Country))
```




```{r echo = FALSE}
# Acertando os nomes dos países nas duas bases para poder juntar de modo apropriado.
# Bahamas
covid19$Country <- stri_replace_all_fixed(covid19$Country,"Bahamas, The","Bahamas", vertorized=TRUE)
ccc$Country <- stri_replace_all_fixed(ccc$Country,"Bahamas, The","Bahamas", vertorized=TRUE)
# [26] "Bolivia"                                             
# [27] "Bolivia (Plurinational State of)"
covid19$Country <- stri_replace_all_regex(covid19$Country, "Bolivia.*", "Bolivia", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Bolivia.*", "Bolivia", vectorize_all = TRUE)
# [27] "Bosnia and Herzegovina"                              
# [28] "Bosnia-Herzegovina"
covid19$Country <- stri_replace_all_regex(covid19$Country, "Bosnia.*", "Bosnia-Herzegovina", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Bosnia.*", "Bosnia-Herzegovina", vectorize_all = TRUE)
# [32] "Brunei"                                              
# [33] "Brunei Darussalam"                                   
covid19$Country <- stri_replace_all_regex(covid19$Country, "Brunei.*", "Brunei", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Brunei.*", "Brunei", vectorize_all = TRUE)
# [38] "Cabo Verde"                                          
# [38] "Cabo Verde"                                          
covid19$Country <- stri_replace_all_regex(covid19$Country, "Ca(pe|bo) Verde", "Cape Verde", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Ca(pe|bo) Verde", "Cape Verde", vectorize_all = TRUE)
# [53] "Congo"                                               
# [54] "Congo (Brazzaville)"                                 
# [55] "Congo (Democratic Republic of the)"                  
# [56] "Congo, Dem. Rep."                                    
# [57] "Congo (Kinshasa)"                                    
# [58] "Congo, Rep."  

#covid19$Country <- stri_replace_all_regex(covid19$Country, "Congo, Rep.*", "Congo (Brazzaville)", vectorize_all = TRUE)
#covid19$Country <- stri_replace_all_regex(covid19$Country, "Congo, Dem.*", "Congo (Kinshasa)", vectorize_all = TRUE)
covid19$Country <- stri_replace_all_regex(covid19$Country, "^Congo$", "Republic of the Congo", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "^Democratic Republic of Congo$", "Democratic Republic of the Congo", vectorize_all = TRUE)
# [60] "Cote d'Ivoire"                                       
# [62] "C\xf4te d'Ivoire"                                 
covid19$Country <- stri_replace_all_regex(covid19$Country, "C(.+)te d(.+)voire", "Ivory Coast", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "C(.+)te d'Ivoire", "Ivory Coast", vectorize_all = TRUE)
# [73] "Egypt"                                               
# [74] "Egypt, Arab Rep."                                    
covid19$Country <- stri_replace_all_regex(covid19$Country, "Egypt.*", "Egypt", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Egypt.*", "Egypt", vectorize_all = TRUE)

# [71] "East Timor"                                          
#[257] "Timor-Leste"
covid19$Country <- stri_replace_all_fixed(covid19$Country, "Timor(.+)Leste", "East Timor", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_fixed(ccc$Country, "Timor(.+)Leste", "East Timor", vectorize_all = TRUE)

# [96] "Gambia"                                              
# [97] "Gambia, The"                                         
covid19$Country <- stri_replace_all_regex(covid19$Country, "Gambia.*", "Gambia", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Gambia.*", "Gambia", vectorize_all = TRUE)

#[114] "Hong Kong, China (SAR)"                              
#[115] "Hong Kong SAR, China"                                
covid19$Country <- stri_replace_all_regex(covid19$Country, "Hong Kong.*", "Hong Kong", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Hong Kong.*", "Hong Kong", vectorize_all = TRUE)

#[125] "Iran"                                                
#[126] "Iran, Islamic Rep."                                  
#[127] "Iran (Islamic Republic of)"                          
covid19$Country <- stri_replace_all_regex(covid19$Country, "Iran.*", "Iran", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Iran.*", "Iran", vectorize_all = TRUE)

#[139] "Korea, Dem. People’s Rep."                           
#[140] "Korea, Rep."                                         
#[141] "Korea (Republic of)"                                 
covid19$Country <- stri_replace_all_regex(covid19$Country, "Korea, Dem.*", "North Korea", vectorize_all = TRUE)
covid19$Country <- stri_replace_all_regex(covid19$Country, "Korea, Rep\\.$", "South Korea", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Korea, South", "South Korea", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Korea, North", "North Korea", vectorize_all = TRUE)

#[136] "Kyrgyz Republic"                                     
#[137] "Kyrgyzstan"                                          
covid19$Country <- stri_replace_all_regex(covid19$Country, "Kyrgyz.*", "Kyrgyzstan", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Kyrgyz.*", "Kyrgyzstan", vectorize_all = TRUE)

#[146] "Lao PDR"                                             
#[147] "Lao People's Democratic Republic"                    
covid19$Country <- stri_replace_all_regex(covid19$Country, "Lao P.*", "Laos", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Lao P.*", "Laos", vectorize_all = TRUE)

#[157] "Macedonia"                                           
#[158] "Macedonia, FYR"                                      
covid19$Country <- stri_replace_all_regex(covid19$Country, "^Macedonia.*", "North Macedonia", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, ".*Macedonia.*", "North Macedonia", vectorize_all = TRUE)

#[178] "Micronesia"                                          
#[179] "Micronesia (Federated States of)"                    
#[180] "Micronesia, Fed. Sts."                               
covid19$Country <- stri_replace_all_regex(covid19$Country, "Micronesia.*", "Micronesia", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Micronesia.*", "Micronesia", vectorize_all = TRUE)

#[185] "Moldova"                                             
#[186] "Moldova (Republic of)"                               
covid19$Country <- stri_replace_all_regex(covid19$Country, "Moldova.*", "Moldova", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Moldova.*", "Moldova", vectorize_all = TRUE)

#[214] "Russia"                                              
#[215] "Russian Federation"                                  
covid19$Country <- stri_replace_all_regex(covid19$Country, "Russia.*", "Russia", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Russia.*", "Russia", vectorize_all = TRUE)

# estes paises nao aparecem no Freedom House; vou desprezar
#[229] "Saint Kitts and Nevis"                                
#[255] "St. Kitts and Nevis"                                  
#[230] "Saint Lucia"                                         
#[256] "St. Lucia"                                           
#[231] "Saint Vincent and the Grenadines"                     
#[257] "St. Vincent and the Grenadines"                      


#[227] "Slovakia"                                            
#[228] "Slovak Republic"                                     
covid19$Country <- stri_replace_all_regex(covid19$Country, "Slovak.*", "Slovakia", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Slovak.*", "Slovakia", vectorize_all = TRUE)

#[252] "Syria"                                               
#[253] "Syrian Arab Republic"                                
covid19$Country <- stri_replace_all_regex(covid19$Country, "Syria.*", "Syria", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Syria.*", "Syria", vectorize_all = TRUE)

#[270] "Tanzania"                                            
#[271] "Tanzania (United Republic of)"                       
covid19$Country <- stri_replace_all_regex(covid19$Country, "Tanzania.*", "Tanzania", vectorize_all = TRUE)
covid19$Country <- stri_replace_all_regex(covid19$Country, "^United Republic of Tanzania$", "Tanzania", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Tanzania.*", "Tanzania", vectorize_all = TRUE)

#[270] "United States"                                       
#[271] "United States of America"                            
covid19$Country <- stri_replace_all_regex(covid19$Country, "United States.*", "USA", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "United States.*", "USA", vectorize_all = TRUE)


#[276] "Venezuela"                                           
#[294] "Venezuela (Bolivarian Republic of)"                  
#[277] "Venezuela, RB"                                       
covid19$Country <- stri_replace_all_regex(covid19$Country, "Venezuela.*", "Venezuela", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Venezuela.*", "Venezuela", vectorize_all = TRUE)


#"Vatican City"
#[55] "Holy See"
ccc$Country <- stri_replace_all_regex(ccc$Country, "^Vatican City.*", "Holy See", vectorize_all = TRUE)


#[296] "Vietnam"                                             
#[297] "Viet Nam"                                            
covid19$Country <- stri_replace_all_regex(covid19$Country, "Viet(\\s|)[nN]am","Vietnam", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country,  "Viet(\\s|)[nN]am","Vietnam", vectorize_all = TRUE)

#[282] "Yemen"                                               
#[283] "Yemen, Rep."
covid19$Country <- stri_replace_all_regex(covid19$Country, "Yemen.*", "Yemen", vectorize_all = TRUE)
ccc$Country <- stri_replace_all_regex(ccc$Country, "Yemen.*", "Yemen", vectorize_all = TRUE)
```



```{r eval=FALSE}
# Agora vou criar a listagem de países que está em todas as bases, isto é, a intersecção dos conjuntos.
# coincidentes
nomes_iguais <- intersect(covid19$Country,ccc$Country)
length(nomes_iguais)
# nao coincidentes
nomes_dif <- setdiff(covid19$Country, ccc$Country)
length(nomes_dif)

# menor subconjunto presente em todos os conjuntos
paises_intersect <- intersect(nomes_iguais, covid19$Country)

# sem Niger e Nigeria
paises_intersect <- paises_intersect[which(!paises_intersect %in% c("Niger","Nigeria"))]
```


> As bases de dados não contém informação do Continente, ou seja, a qual continente pertence cada país. Assim, foi feito um _merge_ com uma base que contém os nomes dos países, continente e a capital de cada país.

> Os nomes dos países foram normalizados entre as bases, acertando grafia e outras inconsistências nos nomes. Países cujo continente não pode ser identificado foi marcado.

<!--
Listagem de todos países na base do COVID-19. Os códigos abaixo são para identificar países que não estão na base `ccc` e acertar os nomes ou incluí-los. Não vou fazer isso agora.
-->

```{r eval = FALSE}
unique(covid19$Country) %>% sort() 
```

```{r eval=FALSE}
intersect(ccc$Country, covid19$Country) %>% sort()
```

```{r eval = FALSE}
setdiff(ccc$Country, covid19$Country)
```
```{r eval = FALSE}
setdiff(covid19$Country,ccc$Country)
```



```{r eval = FALSE}
filter(covid19, Country == "Canada") %>% arrange(DateRep) %>% kable()
```

<!--
Agora parece que conseguimos eliminar as diferenças de grafia entre os países, pelo até hoje (`r format(Sys.time, "%Y-%m-%d")`)
-->

```{r}
covid19 <- left_join(covid19,ccc, by="Country")
```



```{r}
covid19_all <- filter(covid19, is.na(Continent))
covid19 <- filter(covid19, !is.na(Continent))
```

### Alguns gráficos exploratórios com a base EU Open Data Portal

```{r continentsgg}
filter(covid19, DateRep > "2020-02-01") %>% 
  group_by(Continent, DateRep) %>% 
  summarise(numCasos = sum(Cases)) %>% 
  ggplot(aes(x = DateRep, y = numCasos)) + 
  geom_bar(aes(fill=Continent),stat="identity", position = "stack") + 
  labs(x = "Data", title = "Evolução dos Casos nos Continentes, a partir de 01/02/2020",fill="") + 
  scale_fill_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```



```{r eval = FALSE}
filter(covid19, Country != "China") %>% tail(20) %>% kable()
```


```{r continentsggsemchina}
filter(covid19, DateRep > "2020-02-01") %>%
  filter(Country != "China") %>%
  group_by(Continent, DateRep) %>% 
  summarise(numCasos = sum(Cases)) %>% 
  ggplot(aes(x = DateRep, y = numCasos)) + 
  geom_bar(aes(fill=Continent),stat="identity", position = "stack") + 
  scale_fill_discrete(breaks = c("Oceania","Europe","Asia","America","Africa")) +
  labs(x = "Data", title = "Evolução dos Casos nos Continentes (sem China), \na partir de 01/02/2020",fill="") +
  scale_fill_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```

```{r}
sochina <- filter(covid19, Country == "China")
restomundo <- filter(covid19, Country != "China") %>% mutate(Country = "Resto do Mundo")
```

```{r}
restomundo <- group_by(restomundo, DateRep) %>% mutate(Cases = sum(Cases)) %>% ungroup()
```


```{r}
bind_rows(sochina,restomundo) %>% filter(DateRep >= "2020-02-01") %>%
  ggplot(aes(x = DateRep, y = Cases)) +
  geom_bar(aes(fill=Country), stat = "identity", position = "dodge") +
  labs(x = "Data", title = "Número de Novos Casos China x Resto do Mundo, \na partir de 01/02/2020",fill="") + 
  scale_fill_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```


```{r brasil}
filter(covid19, DateRep > "2020-02-01", Country == "Brazil") %>% 
  ggplot(aes(x = DateRep, y = Cases)) + 
  geom_bar(stat="identity", position = "dodge") + 
  labs(x = "Data", title="Número de Casos Reportados diariamente no Brasil\n a partir de 01/02/2020") + 
  scale_fill_brewer(palette = "Set1") +
  labs_pubr() + theme_economist_white()#-> g
#fig <- ggplotly(g)
#fig
```

#### Países com mais de 500 casos confirmados: `r format(ymd(hoje) - 1, '%d-%m-%Y')`

```{r}
covid19 %>% 
  group_by(Country) %>% 
  summarise(Casos = sum(Cases), Mortes = sum(Deaths)) %>% 
  arrange(desc(Casos)) %>% 
  filter(Casos > 500) %>% 
   kable(caption = "Países (com mais de 500 casos) ordenados por número de casos confirmados",col.names = c("País", "Casos","Mortes"))
```


# Base de dados da John Hopkins University

O JHU tem um site de monitoramento em tempo real (talvez o mais atualizado) no endereço `https://coronavirus.jhu.edu/map.html`. Os dados utilizados para o mapa estão em um GitHub  `https://github.com/CSSEGISandData/COVID-19`. Tem dados com atualização diária (parece que no mapa as atualizações são mais constantes; no final do dia são atualizados no GitHub).


Este é o link onde aparece o mapa também: `https://data.humdata.org/dataset/novel-coronavirus-2019-ncov-cases`


## Fazendo o download dos arquivos diários ao invés destes consolidados (não tem o Recovered na última atualização)

O JHU mantém pelo menos 2 formatos dos dados: diários e consolidados (_time series_). Eu tentei utilizar o formato _time series_ inicialmente, mas mudei para o formato diário, de modo que eu mesmo faço a consolidação. Isso permitiu um pouco mais de controle sobre os dados baixados.

Os dados são mantidos neste repositório GitHub:

`https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_daily_reports/`

O nome dos arquivos é MM-DD-YYYY.csv, começando a partir de 22 de Janeiro de 2020.

```{r}
hj <- today()
ontem <- hj - 1
diainicio <- mdy("01-22-2020")
```

```{r}
dia <- diainicio
while(dia <= ontem) {
  ultarq <- paste(format(dia,"%m-%d-%Y"),".csv",sep="")
  CSSEbasepath <- "~/datasets/CSSEGISandData/COVID-19/csse_covid_19_daily_reports/"
  ultarq_fullname <- paste(CSSEbasepath,ultarq,sep="") 
  CSSEURLbase <- "https://github.com/CSSEGISandData/COVID-19/raw/master/csse_covid_19_data/csse_covid_19_daily_reports/"
  if (!file.exists(ultarq_fullname)) {
    curl::curl_download(paste(CSSEURLbase,ultarq,sep=""),ultarq_fullname)
    print(paste("Fazendo dowload do arquivo",ultarq_fullname,sep=":"))
  }
  dia <- dia + 1
}
```

Depois de feito o download de todos os arquivos, é preciso juntá-los em um único `data.frame`. O processo começa com a leitura de todos os `csv`, colocando-os todos em uma `list`.

```{r}
dia <- diainicio
dias <- list()
# mudança de formato a partir de 22 de março de 2020
datamudanca <- ymd("2020-03-22")
while (dia < datamudanca) {
  d1 <- read_csv(paste(CSSEbasepath,format(dia,"%m-%d-%Y"),".csv",sep=""))
  d1 <- rename(d1, Country = `Country/Region`)
  d1 <- group_by(d1,Country) %>% summarise(ConfCases = sum(Confirmed, na.rm = T),TotDeaths = sum(Deaths, na.rm = T), TotRecov = sum(Recovered, na.rm = T)) %>% mutate(DateRep = dia)
  dias <- append(dias,list(d1))
  dia <- dia + 1
}
# novo formato
while(dia <= ontem) {
  d1 <- read_csv(paste(CSSEbasepath,format(dia,"%m-%d-%Y"),".csv",sep=""))
  d1 <- rename(d1, Country = Country_Region)
  d1 <- group_by(d1,Country) %>% summarise(ConfCases = sum(Confirmed, na.rm = T), TotDeaths = sum(Deaths, na.rm = T), TotRecov = sum(Recovered, na.rm = T)) %>% mutate(DateRep = dia)
  dias <- append(dias, list(d1))
  dia <- dia + 1
  }
```

Com a lista de todos os arquivos (`data.frame`s) diários, a função `bind_rows` do `dplyr` faz a concatenação. Algumas correções de nomes de países são também realizadas, visando normalizar e acertar grafias.

```{r}
X <- bind_rows(dias) %>% arrange(DateRep,Country)
assign("jhucovid19",X)
jhucovid19 <- select(jhucovid19, Country, DateRep, ConfirmedCases = ConfCases, Deaths = TotDeaths, Recovered = TotRecov)
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country,"Mainland China", "China", vectorize_all = TRUE)
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "UK", "United Kingdom", vectorize_all = TRUE)
rm(X)
```


```{r echo = FALSE}
# Bahamas
jhucovid19$Country <- stri_replace_all_fixed(jhucovid19$Country,"Bahamas, The","Bahamas", vectorize_all = TRUE)

# [26] "Bolivia"                                             
# [27] "Bolivia (Plurinational State of)"
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Bolivia.*", "Bolivia", vectorize_all = TRUE)

# [27] "Bosnia and Herzegovina"                              
# [28] "Bosnia-Herzegovina"
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Bosnia.*", "Bosnia-Herzegovina", vectorize_all = TRUE)

# [32] "Brunei"                                              
# [33] "Brunei Darussalam"                                   
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Brunei.*", "Brunei", vectorize_all = TRUE)

# [38] "Cabo Verde"                                          
# [38] "Cabo Verde"                                          
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Ca(pe|bo) Verde", "Cape Verde", vectorize_all = TRUE)

# [53] "Congo"                                               
# [54] "Congo (Brazzaville)"                                 
# [55] "Congo (Democratic Republic of the)"                  
# [56] "Congo, Dem. Rep."                                    
# [57] "Congo (Kinshasa)"                                    
# [58] "Congo, Rep."  

#jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Congo, Rep.*", "Congo (Brazzaville)", vectorize_all = TRUE)
#jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Congo, Dem.*", "Congo (Kinshasa)", vectorize_all = TRUE)
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "^Congo$", "Republic of the Congo", vectorize_all = TRUE)

# [60] "Cote d'Ivoire"                                       
# [62] "C\xf4te d'Ivoire"                                 
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "C(.+)te d(.+)voire", "Ivory Coast", vectorize_all = TRUE)

# [73] "Egypt"                                               
# [74] "Egypt, Arab Rep."                                    
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Egypt.*", "Egypt", vectorize_all = TRUE)

# [71] "East Timor"                                          
#[257] "Timor-Leste"
jhucovid19$Country <- stri_replace_all_fixed(jhucovid19$Country, "Timor(.+)Leste", "East Timor", vectorize_all = TRUE)


# [96] "Gambia"                                              
# [97] "Gambia, The"                                         
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Gambia.*", "Gambia", vectorize_all = TRUE)

#[114] "Hong Kong, China (SAR)"                              
#[115] "Hong Kong SAR, China"                                
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Hong Kong.*", "Hong Kong", vectorize_all = TRUE)

#[125] "Iran"                                                
#[126] "Iran, Islamic Rep."                                  
#[127] "Iran (Islamic Republic of)"                          
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Iran.*", "Iran", vectorize_all = TRUE)

#[139] "Korea, Dem. People’s Rep."                           
#[140] "Korea, Rep."                                         
#[141] "Korea (Republic of)"                                 
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Korea, Dem.*", "North Korea", vectorize_all = TRUE)
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Korea, Rep\\.$", "South Korea", vectorize_all = TRUE)

#[136] "Kyrgyz Republic"                                     
#[137] "Kyrgyzstan"                                          
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Kyrgyz.*", "Kyrgyzstan", vectorize_all = TRUE)

#[146] "Lao PDR"                                             
#[147] "Lao People's Democratic Republic"                    
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Lao P.*", "Laos", vectorize_all = TRUE)

#[157] "Macedonia"                                           
#[158] "Macedonia, FYR"                                      
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "^Macedonia.*", "North Macedonia", vectorize_all = TRUE)

#[178] "Micronesia"                                          
#[179] "Micronesia (Federated States of)"                    
#[180] "Micronesia, Fed. Sts."                               
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Micronesia.*", "Micronesia", vectorize_all = TRUE)

#[185] "Moldova"                                             
#[186] "Moldova (Republic of)"                               
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Moldova.*", "Moldova", vectorize_all = TRUE)

#[214] "Russia"                                              
#[215] "Russian Federation"                                  
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Russia.*", "Russia", vectorize_all = TRUE)

# estes paises nao aparecem no Freedom House; vou desprezar
#[229] "Saint Kitts and Nevis"                                
#[255] "St. Kitts and Nevis"                                  
#[230] "Saint Lucia"                                         
#[256] "St. Lucia"                                           
#[231] "Saint Vincent and the Grenadines"                     
#[257] "St. Vincent and the Grenadines"                      


#[227] "Slovakia"                                            
#[228] "Slovak Republic"                                     
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Slovak.*", "Slovakia", vectorize_all = TRUE)

#[252] "Syria"                                               
#[253] "Syrian Arab Republic"                                
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Syria.*", "Syria", vectorize_all = TRUE)

#[270] "Tanzania"                                            
#[271] "Tanzania (United Republic of)"                       
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Tanzania.*", "Tanzania", vectorize_all = TRUE)
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "^United Republic of Tanzania$", "Tanzania", vectorize_all = TRUE)

#[270] "United States"                                       
#[271] "United States of America"                            
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "United States.*", "USA", vectorize_all = TRUE)
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "US", "USA", vectorize_all = TRUE)

#[276] "Venezuela"                                           
#[294] "Venezuela (Bolivarian Republic of)"                  
#[277] "Venezuela, RB"                                       
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Venezuela.*", "Venezuela", vectorize_all = TRUE)

#"Vatican City"
#[55] "Holy See"
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "^Vatican City.*", "Holy See", vectorize_all = TRUE)

#[296] "Vietnam"                                             
#[297] "Viet Nam"                                            
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Viet(\\s|)[nN]am","Vietnam", vectorize_all = TRUE)

#[282] "Yemen"                                               
#[283] "Yemen, Rep."
jhucovid19$Country <- stri_replace_all_regex(jhucovid19$Country, "Yemen.*", "Yemen", vectorize_all = TRUE)
```


```{r}
jhucovid19 <- jhucovid19 %>%  group_by(DateRep, Country) %>% 
  mutate(ConfirmedCases = sum(ConfirmedCases), Deaths = sum(Deaths), Recovered = sum(Recovered)) %>% 
  ungroup() %>% ungroup()
```


```{r}
# Adicionando coluna "Continent"
jhucovid19 <- left_join(jhucovid19,ccc, by="Country")
```



```{r}
# Removendo países sem continente.
jhucovid19_all <- jhucovid19
jhucovid19 <- filter(jhucovid19, !is.na(Continent)) %>% select(-Capital)
```

```{r}
write_csv(jhucovid19,paste("./data/","jhucovid19-",ontem,".csv",sep=""))
```

### Total de Casos pelos dados da John Hopkins University (JHU): `r format(ymd(hoje) - 1, '%d-%m-%Y')`


```{r}
 jhucovid19 %>% 
  group_by(Country) %>% 
  summarise(CasosPais = last(ConfirmedCases), MortosPais = last(Deaths), RecuperadosPais = last(Recovered)) %>% 
  summarise(`Casos Confirmados` = sum(CasosPais), Mortos = sum(MortosPais), Recuperados = sum(RecuperadosPais)) %>% kable()
```

### Últimos 10 dias para alguns países: `r format(ymd(hoje) - 1, '%d-%m-%Y')`


```{r}
filter(jhucovid19, Country == "France") %>% top_n(10,DateRep) %>% kable(caption = "França")
```


```{r}
filter(jhucovid19, Country == "Italy") %>% top_n(10,DateRep) %>% kable(caption = "Itália")
```

```{r}
filter(jhucovid19, Country == "Spain") %>% top_n(10,DateRep) %>% kable(caption = "Espanha")
```

```{r}
filter(jhucovid19, Country == "Brazil") %>% top_n(10,DateRep) %>% kable(caption = "Brasil")
```


Para poder estudar o crescimento do número de casos e de mortes, foi adicionada uma coluna com o número de casos de um dia para o outro, já que a base de dados reporta o total de casos em cada dia e não quantos casos foram registrados naquele dia.

```{r}
jhucovid19 <- group_by(jhucovid19, Country) %>% 
  arrange(DateRep) %>%
  mutate(NewDeaths = Deaths - lag(Deaths), 
         NewCases = ConfirmedCases - lag(ConfirmedCases),
         NewCases = if_else(is.na(NewCases), 0, if_else(NewCases < 0, 0, NewCases)),
         NewDeaths = if_else(is.na(NewDeaths), 0, if_else(NewDeaths < 0, 0, NewDeaths))
         ) %>%
  ungroup()
```

### Lista de países ordenados por número de casos confirmados: `r format(ymd(hoje) - 1, '%d-%m-%Y')`

```{r}
group_by(jhucovid19, Country) %>% 
  summarise(ConfirmedCases = last(ConfirmedCases), Deaths = last(Deaths), Recuperados = last(Recovered)) %>% 
  arrange(desc(ConfirmedCases)) %>% 
  kable(col.names = c("País", "Casos","Mortes","Recuperados"))
```


### Alguns gráficos exploratórios com a base do JHU


```{r}
filter(jhucovid19, Country %in% c("China","Italy","Iran","Germany","Japan"), DateRep >= ymd("2020-02-01")) %>% 
  ggplot(aes(x = DateRep, y = NewCases)) + geom_bar(aes(fill=Country),stat="identity", position="dodge") +
  labs(x = "Data Reportado", y = "Novos Casos", title = "Novos Casos a partir de 01 de Fev 2020", fill="") +
  labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```



```{r eval = FALSE}
filter(jhucovid19,  grepl("China",Country)) %>% kable() #%>% summarise(sum(ConfirmedCases))
```

<!--
Este trecho calcula a diferença que obtenho ao somar os "NewCases" em relação ao total de casos confirmados ("ConfirmedCases"). Não consegui identificar a origem da diferença; uma possibilidade é que a base não começa com o primeiro caso da China, mas em 22 de Janeiro, já com 547 casos confirmados. Ou seja, precisaria fazer mais alguns ajustes nesta variával `NewCases` para, quando acumulada, chegasse ao valor dos `ConfirmedCases` do último dia da base.
-->

```{r eval = FALSE}
jhucovid19 %>% group_by(Country) %>% summarise(Confirmed1 = sum(NewCases) - sum(NewDeaths, na.rm=T), Confirmed2 = last(ConfirmedCases), Diferenca = Confirmed2 - Confirmed1) %>% arrange(desc(Confirmed1)) %>% kable()
```


```{r eval = FALSE}
jhucovid19 %>% filter(Country == "Italy") %>% top_n(10, DateRep)
```


```{r}
filter(jhucovid19, DateRep > "2020-02-01") %>% 
  group_by(Continent, DateRep) %>% 
  summarise(numCasos = sum(ConfirmedCases)) %>% 
  ggplot(aes(x = DateRep, y = numCasos)) + 
  geom_bar(aes(fill=Continent),stat="identity", position = "dodge") + 
  labs(x = "Data", title = "Total de Casos nos Continentes (dados JHU),\n a partir de 01/02/2020",fill="") + 
  scale_fill_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```


```{r}
Italia14 <- filter(jhucovid19, Country == "Italy") %>% 
  filter(ConfirmedCases >= 1 ) %>%  
  select(Country,DateRep, ConfirmedCases,Deaths) 
Brasil13 <- filter(jhucovid19, Country == "Brazil") %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths)
```
```{r}
Italia14 <- mutate(Italia14, Dia = as.numeric(rownames(Italia14))) %>%
  top_n(-25, Dia)
Brasil13 <- mutate(Brasil13, Dia = as.numeric(rownames(Brasil13))) %>%
  top_n(-25, Dia)
```

```{r  eval = FALSE}
Italia14 %>% kable()
```
```{r eval = FALSE}
Brasil13 %>% kable()
```

```{r}
bind_rows(Italia14,Brasil13) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(color = Country, shape = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 1º caso", color = "", title = "Evolução dos 25 primeiros dias após o 1º caso") + guides(shape = FALSE) + labs_pubr() + theme_economist_white() # -> g
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "USA")) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-55, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 1º caso", shape = "", color= "", title = "Evolução dos 55 primeiros dias após o 1º caso")  + scale_color_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "USA")) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 14 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-35, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 14º caso", shape = "", color= "", title = "Evolução dos 35 primeiros dias após o 14º caso")  + scale_color_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() # -> g
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "USA", "Japan")) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  mutate(Dia = row_number()) %>%
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 30º caso", shape = "", color= "", title = "Evolução após o 30º caso")  + scale_color_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() # -> g
#fig <- ggplotly(g)
#fig
```

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "Japan","USA", "Argentina","Chile")) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  group_by(DateRep,Country) %>% summarise(ConfCases = sum(ConfirmedCases)) %>% ungroup() %>%
  pivot_wider(id_cols =  DateRep, names_from = Country, values_from = ConfCases) %>% 
  kable(caption = "Evolução dos casos após o 30º caso confirmado")
```



### Calculando a taxa de progressão dia-a-dia: Brasil, Itália, USA, França, Alemanha, Espanha

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "Japan","USA","China")) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1) %>% 
  arrange(DateRep) %>%
  mutate(ProgRateDeaths = (Deaths - lag(Deaths))/lag(Deaths), 
         ProgRateCases = (ConfirmedCases - lag(ConfirmedCases))/lag(ConfirmedCases),
         ProgRateDeaths = ProgRateDeaths + 1,
         ProgRateCases = ProgRateCases + 1
         ) %>%
  filter(DateRep >= ymd("2020-03-01")) %>% mutate(DateRep = format(DateRep,"%Y-%m-%d"), ProgRateCases = format(ProgRateCases, digits = 3)) %>%
  select(Country,DateRep,ProgRateCases) %>%
  pivot_wider(names_from = Country, values_from = ProgRateCases) %>% kable()
```



```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "Japan","USA", "China")) %>% 
  group_by(Country) %>% 
  arrange(DateRep) %>%
  mutate(ProgRateDeaths = (Deaths - lag(Deaths))/lag(Deaths), 
         ProgRateCases = (ConfirmedCases - lag(ConfirmedCases))/lag(ConfirmedCases),
         ProgRateDeaths = ProgRateDeaths + 1,
         ProgRateCases = ProgRateCases + 1
         ) %>%
  ungroup() %>%
  filter(DateRep >= ymd("2020-03-01")) %>%
  select(Country,DateRep,ConfirmedCases, ProgRateCases) -> dg
ggplot(data = dg, aes(x = DateRep, y = ProgRateCases)) +  
  geom_point(aes(color = Country, linetype = Country)) + 
  geom_smooth(aes(color = Country), se = FALSE, span = 0.15) +
  labs(color="") + guides(shape = "none", linetype="none") +  labs_pubr() + theme_economist_white() 
```

## Países com números de casos semelhantes ao Brasil: `r format(ymd(hoje) - 1, '%d-%m-%Y')`

Olhando os dados de:
 - Portugal
 - Suécia (Sweden)
 - Turquia (Turkey)
 - Israel
 - Austrália (Australia)


```{r}
filter(jhucovid19, Country %in% c("Brazil", "Portugal", "Sweden", "Turkey", "Israel", "Australia")) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-55, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 1º caso", shape = "", color= "", title = "Evolução dos 55 primeiros dias após o 1º caso")  + scale_color_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% c("Brazil", "Portugal", "Sweden", "Turkey", "Israel", "Australia")) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 14 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-35, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 14º caso", shape = "", color= "", title = "Evolução dos 35 primeiros dias após o 14º caso")  + scale_color_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() # -> g
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% c("Brazil", "Portugal", "Sweden", "Turkey", "Israel", "Australia")) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  mutate(Dia = row_number()) %>%
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country)) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 30º caso", shape = "", color= "", title = "Evolução após o 30º caso")  + scale_color_brewer(palette = "Set1") + labs_pubr() + theme_economist_white() #-> g
#fig <- ggplotly(g)
#fig
```

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% c("Brazil", "Portugal", "Sweden", "Turkey", "Israel", "Australia")) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  group_by(DateRep,Country) %>% summarise(ConfCases = sum(ConfirmedCases)) %>% ungroup() %>%
  pivot_wider(id_cols =  DateRep, names_from = Country, values_from = ConfCases) %>% 
  kable(caption = "Evolução dos casos após o 30º caso confirmado")
```


#### Calculando a taxa de progressão dia-a-dia: Brazil, Portugal, Sweden, Turkey, Israel, Australia

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% c("Brazil", "Portugal", "Sweden", "Turkey", "Israel", "Australia")) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1) %>% 
  arrange(DateRep) %>%
  mutate(ProgRateDeaths = (Deaths - lag(Deaths))/lag(Deaths), 
         ProgRateCases = (ConfirmedCases - lag(ConfirmedCases))/lag(ConfirmedCases),
         ProgRateDeaths = ProgRateDeaths + 1,
         ProgRateCases = ProgRateCases + 1
         ) %>%
  filter(DateRep >= ymd("2020-03-01")) %>% mutate(DateRep = format(DateRep,"%Y-%m-%d"), ProgRateCases = format(ProgRateCases, digits = 3)) %>%
  select(Country,DateRep,ProgRateCases) %>%
  pivot_wider(names_from = Country, values_from = ProgRateCases) %>% kable()
```



```{r}
filter(jhucovid19, Country %in% c("Brazil", "Portugal", "Sweden", "Turkey", "Israel", "Australia")) %>% 
  group_by(Country) %>% 
  arrange(DateRep) %>%
  mutate(ProgRateDeaths = (Deaths - lag(Deaths))/lag(Deaths), 
         ProgRateCases = (ConfirmedCases - lag(ConfirmedCases))/lag(ConfirmedCases),
         ProgRateDeaths = ProgRateDeaths + 1,
         ProgRateCases = ProgRateCases + 1
         ) %>%
  ungroup() %>%
  filter(DateRep >= ymd("2020-03-01")) %>%
  select(Country,DateRep,ConfirmedCases, ProgRateCases) -> dg
ggplot(data = dg, aes(x = DateRep, y = ProgRateCases)) +  
  geom_point(aes(color = Country, linetype = Country)) + 
  geom_smooth(aes(color = Country), se = FALSE, span = 0.15) +
  labs(color="") + guides(shape = "none", linetype="none") + labs_pubr() + theme_economist_white() 
```

# Base de dados do Worldometer

Esta base de dados tem uma atualização bem interessante, com algumas variáveis também interessantes.

Ela está disponível em `https://www.worldometers.info/coronavirus/`

O problema é que não achei nenhum `csv` ou `xlsx` para baixar; então vou tentar fazer um _web scraping_ e pegar os dados. Utilizando o pacote `rvest` e seguindo a dica [deste post](https://www.r-bloggers.com/using-rvest-to-scrape-an-html-table/) foi razoavelmente fácil. 

```{r}
url <- "https://www.worldometers.info/coronavirus/"
coronaworldometer <- url %>%
  html() %>%
  html_nodes(xpath='//*[@id="main_table_countries_today"]') %>% 
  html_table()
```
```{r}
womcovid19 <- coronaworldometer[[1]]
```

Olhando a estrutura destes dados:

```{r}
str(womcovid19)
```

Depois de pegar a tabela em html e colocar em um `data.frame`, algumas limpezas e transformações são necessárias: algumas colunas, como a `NewCases`, tem o símbolo `+`; os números vieram formatados como _strings_ com separador de milhar (`,`), e algumas outras coisas. Então, algumas manipulações serão feitas para acertar isso.

```{r}
head(womcovid19) %>% kable()
```

```{r}
womcovid19 <- womcovid19 %>% 
  rename(Country = `Country,Other`, SeriousCritical = `Serious,Critical`) %>% 
  rename(Cases1M = contains("Cases/1M pop"), Deaths1M = contains("Deaths/1M pop")) %>% 
  mutate_at(vars(TotalCases,NewCases,TotalDeaths,NewDeaths,TotalRecovered,ActiveCases,SeriousCritical,Cases1M, Deaths1M), str_remove ,"," )  %>%
  mutate_at(vars(NewCases,NewDeaths), str_remove , "\\+" ) %>%
  mutate_at(vars(TotalCases,NewCases,TotalDeaths,NewDeaths,TotalRecovered,ActiveCases,SeriousCritical,Cases1M, Deaths1M), as.numeric, na.rm=TRUE) %>% 
  filter(Country != "Total:")
```

### Total de Casos pelos dados do Worldometer: `r format(ymd(hoje), '%d-%m-%Y')`

```{r}
womcovid19 %>%
  select(TotalCases, TotalDeaths, TotalRecovered) %>% 
  dplyr::summarise(TotalCasos = sum(TotalCases,na.rm = T), TotalMortes=sum(TotalDeaths,na.rm = T), TotalRecuperados = sum(TotalRecovered,na.rm = T)) %>%
  kable()
```


### Lista de países ordenados por número de casos confirmados: `r format(ymd(hoje), '%d-%m-%Y')`

```{r}
womcovid19 %>% 
  select(Country, TotalCases, TotalDeaths, TotalRecovered) %>% 
  arrange(desc(TotalCases)) %>%
  kable()
```


# Dados do Kaggle - Coronavirus - Brazil

Estes dados são mantidos pelo Raphael Fontes, com uma atualização constante.

Link: `https://www.kaggle.com/unanimad/corona-virus-brazil`

O link direto para os dados é: `https://www.kaggle.com/unanimad/corona-virus-brazil/download` que fornece um arquivo zip com o CSV.

O download da base de dados é feita com a API do Kaggle; é um pacote do Python. A base vem compactada, então depois de fazer o download, utilizo o pacote `zip` para extraí-la.

```{r}
system("cd data;/home/mario/.local/bin/kaggle datasets download unanimad/corona-virus-brazil")
zip::unzip("./data/corona-virus-brazil.zip", exdir = "./data")
```

```{r}
brcovid19 <- read_csv("./data/brazil_covid19.csv", col_types = cols(date = col_date(format = "%Y-%m-%d")))
```

```{r}
str(brcovid19)
```

```{r}
brcovid19 <- brcovid19 %>% mutate(Data = date, Casos = cases, Mortes = deaths, Regiao = region, Estado = state)
```

```{r brcovid}
brcovid19 %>% group_by(Data) %>% summarise(CasosTot = sum(Casos), MortesTot = sum(Mortes)) %>%
filter(CasosTot > 0) %>% 
  gather(key = "Ocorrencia", value = "Valor", CasosTot:MortesTot) %>% 
  ggplot(aes(x = Data, y = Valor, fill = Ocorrencia)) + 
  geom_bar(stat="identity", position = "dodge") +
  labs(x = "Data", title="Número de Casos Reportados diariamente no Brasil", fill ="", y = "") + 
  scale_fill_brewer(palette = "Set1") +
  labs_pubr() + theme_economist_white()
```

------------

<span><a href="https://momenezes.github.io/covid19/"><img src="./back.png" alt="HOME" width="60" style="vertical-align:middle">  <b>HOME  </b> </a></span>
