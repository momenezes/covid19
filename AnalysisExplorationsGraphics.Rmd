---
title: "Algumas Análises e Explorações COVID-19"
author: "Mario O. de Menezes"
date: "Brazil"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    fig_height: 6
    fig_width: 8
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, knitr.kable.NA = '', tidy.opts = list(width.cutoff = 80))
```

```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(lubridate)
library(forcats)
library(ggpubr)
library(readxl)
library(knitr)
library(stringi)
library(RColorBrewer)
library(ggthemes)
library(plotly)
library(rvest)
library(data.table)
library(scales)
library(kableExtra)
library(DT)
library(plotly)
library(formattable)
library(gganimate)
```


```{r}
theme_set(theme_clean())
```

# Introdução

A pandemia do novo coronavirus tomou o mundo de assalto. Notícias em todo o lugar dão conta do rápido alastramento do vírus em todo o mundo, e os seus números são alarmantes. 

Para permitir que mais e mais pessoas possam ajudar no combate ao vírus, das mais diversas formas, organizações ao redor do mundo tem disponibilizado dados sobre a evolução da COVID-19 em todo o globo.

Dentre as organizações que disponibilizam dados estão a [European Union Open Data Portal](https://data.europa.eu/euodp/en/home), a [John Hopkins University](https://github.com/CSSEGISandData/2019-nCoV) através de um repositório no GitHub.

Com abundância de dados, me propus a realizar algumas explorações e tabulações destes dados visando entender melhor o cenário mundial.

#### Disclaimer

_Este é um trabalho em andamento; não tem cunho científico e nem pretende que sirva de embasamento para qualquer tomada de decisão. É uma abordagem estritamente pessoal._

<span><a href="https://momenezes.github.io/covid19/"><img src="./back.png" alt="HOME" width="60" style="vertical-align:middle">  <b>HOME  </b> </a></span>


------------

### Bases de Dados

Existem várias bases de dados disponíveis sobre a evolução da COVID-19 no mundo. Dentre estas, estou utilizando três para algumas análises e explorações:

* EU Open Data Portal
* CSSE at Johns Hopkins University
* Kaggle -- Coronavirus - Brazil, Coronavirus (COVID-19) - Brazil Dataset (by Raphael Fontes) - tks Raphael :-)

Uma base interessante pela atualização é o Worldometer, mas infelizmente ele só oferece instantâneos, não tem série histórica.

O download e preparação das bases é feito em um notebook separado para não poluir muito aqui. O link é: [Preparação dos Dados](dataprep.html)

# Base de dados do EU Open Data Portal {#EEUU}


```{r lerEU}
# Leitura do último arquivo disponível
covid19 <- read_csv("./data/eeuucovid19_last.csv")
```
 
```{r}
covid19 <- covid19 %>% select(-countryterritoryCode)
```
 
```{r}
Fonte = "Fonte: EU Open Data Portal"
```
 
```{r}
ultimadata <- max(covid19$DateRep)
```

#### Total de Casos pelos dados da EU Open Data Portal: `r format(ultimadata, '%d-%m-%Y')`



```{r}
covid19 %>% 
  summarise(Casos = sum(Cases), Mortes = sum(Deaths), Letalidade = sprintf("%s%%", round(Mortes/Casos*100,2))) %>% 
  kable(align = "r")
```


```{r eval=FALSE}
covid19 %>% 
  group_by(Continent) %>% 
  summarise(Casos = as.integer(sum(Cases)), Mortes = as.integer(sum(Deaths)), Letalidade = round(Mortes/Casos*100,2)) %>% 
  filter(!is.na(Continent)) %>%
  gather( key = "Tipo", value = "Valor", 2:3) %>%
  ggplot(aes(x = reorder(Continent,Valor), y = Valor, fill = Tipo)) + 
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(x = Continent, y = Valor, label = Valor), hjust = -0.7, size = 3, color = "black") +
  labs(fill = "", x = "", y = "") + scale_y_continuous(labels = label_number_auto()) + labs_pubr() +  coord_flip()
  
```


## Brasil vs Itália {#BRvsIT}

```{r}
Italia <- covid19 %>% 
  filter(Country == "Italy")%>% 
  arrange(DateRep) %>%
  mutate(CumCases = cumsum(Cases))
Brasil <- covid19 %>% 
  filter(Country == "Brazil") %>%
  arrange(DateRep) %>%
  mutate(CumCases = cumsum(Cases))
```

Uma mostra dos últimos 20 dias da Itália.
```{r}
Italia %>% select(-Country, -Continent, -popData2018) %>% top_n(20, DateRep) %>% 
  mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>% datatable(rownames = F, autoHideNavigation = T , options = list(searching = FALSE))
  
```

O mesmo para o Brasil, últimos 20 dias.
```{r}
Brasil %>% select(-Country, -Continent, -popData2018) %>% top_n(20, DateRep) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
  datatable(rownames = F, autoHideNavigation = T, options = list(searching = FALSE) )
```

```{r}
LimiteCorte <- max(Brasil$CumCases)
```

```{r}
Italia14 <- Italia %>% 
  filter(CumCases >= 14 & CumCases <= LimiteCorte) %>% 
  select(Country,DateRep, Cases,Deaths,CumCases)
Brasil13 <- Brasil %>% 
  filter(CumCases >= 14 & CumCases <= LimiteCorte) %>% 
  select(Country,DateRep,Cases,Deaths,CumCases)
```
```{r}
Italia14 <- mutate(Italia14, Dia = as.numeric(rownames(Italia14)))
Brasil13 <- mutate(Brasil13, Dia = as.numeric(rownames(Brasil13)))
```

```{r eval = FALSE}
Italia14 %>% kable()
```


```{r eval = FALSE}
Brasil13 %>% kable()
```



```{r}
bind_rows(Italia14,Brasil13) %>%  mutate(DateRep = as.Date(DateRep)) %>% 
  ggplot() + geom_point(aes(x = Dia, y = CumCases, color=Country), size = 2) + 
  labs(title = "Número cumulativo de casos", subtitle = paste("CumCases>=14 & CumCases<=", LimiteCorte), caption = Fonte, color = "", y = "Casos acumulados", x = "Dias decorridos") + labs_pubr() + scale_color_discrete(l = 40,c = 150) 

```


```{r}
bind_rows(select(Italia,Country, DateRep, CumCases, Cases, Deaths), select(Brasil, Country, DateRep, CumCases, Cases, Deaths)) %>% filter(DateRep >= "2020-02-22") %>%  mutate(DateRep = as.Date(DateRep)) %>%
   ggplot() + geom_bar(aes(x = DateRep, y = CumCases, fill = Country), stat = "identity", position = "dodge") + 
  labs(y = "Núm de Casos (acum)", x = "", title = "Evolução dos Casos na Italia e Brasil, a partir de 22/02/2020",
  caption = Fonte, fill = "") + scale_fill_brewer(palette = "Set1")  + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) # -> g
#fig <- ggplotly(g)
#fig
```


```{r italiagg}
covid19 %>% 
  filter(Country %in% c("Italy", "Brazil"), DateRep > "2020-02-22") %>% 
  arrange(DateRep) %>%  mutate(DateRep = as.Date(DateRep)) %>%
  ggplot() + geom_bar(aes(x = DateRep, y = Cases, fill = Country),  stat = "identity", position = "dodge") + 
  labs(y = "Número de Casos/dia", x = "", title = "Número de Casos Reportados diariamente na Italia e Brasil,\n a partir de 22/02/2020", caption = Fonte, fill = "")  + scale_fill_brewer(palette = "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1))  #-> g
#fig <- ggplotly(g)
#fig
```

```{r}
CasosRemovidos <- filter(covid19, is.na(Continent))
numNAsCont <- CasosRemovidos %>% count() %>% as.numeric()
numCasosSemCont <- CasosRemovidos %>% group_by(Country) %>% summarise(Casos = sum(Cases)) %>% summarise(CasosTot = sum(Casos)) %>% select(CasosTot) %>% as.numeric()
```


Como a base de dados contém alguns _países_ estranhos, como o navio de cruzeiro ancorado no Japão, alguns territórios em disputa, como Kosovo, vou eliminar todas as observações que não tem o Continente especificado. São `r numNAsCont` observações, que totalizam `r numCasosSemCont` casos. 

```{r}
covid19 <- filter(covid19, !is.na(Continent))
```

### Alguns gráficos exploratórios com a base EU Open Data Portal {#GREEUU}

```{r continentsgg}
filter(covid19, DateRep > "2020-02-01") %>% 
  group_by(Continent, DateRep) %>% 
  summarise(numCasos = sum(Cases)) %>% 
  mutate(DateRep = as.Date(DateRep)) %>%
  ggplot(aes(x = DateRep, y = numCasos)) + 
  geom_bar(aes(fill=Continent),stat="identity", position = "stack") + 
  labs(x = "", y = "Número Casos/dia", title = "Evolução dos Casos nos Continentes, a partir de 01/02/2020",
       caption = Fonte, fill="") + 
  scale_fill_brewer(palette = "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) #-> g
#fig <- ggplotly(g)
#fig
```



```{r eval = FALSE}
filter(covid19, Country != "China") %>% tail(20) %>% kable()
```


```{r continentsggsemchina}
filter(covid19, DateRep > "2020-02-01") %>%
  filter(Country != "China") %>%
  group_by(Continent, DateRep) %>% 
  summarise(numCasos = sum(Cases)) %>%
  mutate(DateRep = as.Date(DateRep)) %>% 
  ggplot(aes(x = DateRep, y = numCasos)) + 
  geom_bar(aes(fill=Continent),stat="identity", position = "stack") + 
  scale_fill_discrete(breaks = c("Oceania","Europe","Asia","America","Africa")) +
  labs(x = "", y ="Número Casos/dia", title = "Evolução dos Casos nos Continentes (sem China), \na partir de 01/02/2020",
       caption = Fonte,fill="") +
  scale_fill_brewer(palette = "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) #-> g
#fig <- ggplotly(g)
#fig
```

```{r}
sochina <- filter(covid19, Country == "China")
restomundo <- filter(covid19, Country != "China") %>% mutate(Country = "Resto do Mundo")
```

```{r}
restomundo <- group_by(restomundo, DateRep) %>% mutate(Cases = sum(Cases)) %>% ungroup()
```


```{r}
bind_rows(sochina,restomundo) %>% filter(DateRep >= "2020-02-01") %>%
  mutate(DateRep = as.Date(DateRep)) %>%
  ggplot(aes(x = DateRep, y = Cases)) +
  geom_bar(aes(fill=Country), stat = "identity", position = "dodge") +
  labs(x = "", y = "Número Casos/dia",  title = "Número de Novos Casos China x Resto do Mundo, \na partir de 01/02/2020",
       caption = Fonte, fill="") + 
  scale_fill_brewer(palette = "Set1")  + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1))

#-> g
#fig <- ggplotly(g)
#fig
```


```{r brasil}
filter(covid19, DateRep > "2020-02-01", Country == "Brazil") %>% 
  mutate(DateRep = as.Date(DateRep)) %>% 
  ggplot(aes(x = DateRep, y = Cases)) + 
  geom_bar(stat="identity", position = "dodge", fill = "red") + 
  labs(x = "", y = "Novos Casos/dia", title="Número de Casos Reportados diariamente no Brasil\n a partir de 01/02/2020", 
       caption = Fonte) + 
  scale_fill_brewer(palette = "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1))
#-> g
#fig <- ggplotly(g)
#fig
```

#### Países com mais de 500 casos confirmados: `r format(ultimadata, '%d-%m-%Y')`  {#EEUUpaises}

```{r}
covid19 %>% 
  group_by(Country) %>% 
  summarise(Casos = sum(Cases), Mortes = sum(Deaths)) %>% 
  arrange(desc(Casos)) %>% 
  filter(Casos > 500) %>% datatable(rownames = F, autoHideNavigation = T )
#  kable(caption = "Países (com mais de 500 casos) ordenados por número de casos confirmados",col.names = c("País", "Casos","Mortes"), escape = F, align = "c") %>%
#  kable_styling(c("striped", "condensed"), full_width = F)
```


# Base de dados da John Hopkins University {#JHU}

```{r}
jhucovid19 <- read_csv("./data/jhucovid19_last.csv")
```


```{r}
Fonte = "Fonte: CSSE at Johns Hopkins University"
```

```{r}
ultimadata <- max(jhucovid19$DateRep)
```





### Total de Casos pelos dados da John Hopkins University (JHU): `r format(ultimadata, '%d-%m-%Y')` {#JHUtotal}


```{r}
 jhucovid19 %>% 
  group_by(Country) %>% 
  summarise(CasosPais = last(ConfirmedCases), MortosPais = last(Deaths), RecuperadosPais = last(Recovered)) %>% 
  summarise(`Casos Confirmados` = sum(CasosPais), Mortos = sum(MortosPais), Recuperados = sum(RecuperadosPais)) %>% kable()
```


```{r}
CasosRemovidos <- filter(jhucovid19, is.na(Continent))
numNAsCont <- CasosRemovidos %>% count() %>% as.numeric()
numCasosSemCont <- CasosRemovidos %>% group_by(Country) %>% summarise(Casos = sum(ConfirmedCases)) %>% summarise(CasosTot = sum(Casos)) %>% select(CasosTot) %>% as.numeric()
```


```{r}
jhucovid19 <- filter(jhucovid19, !is.na(Continent))
```


```{r}
ultimadata <- max(jhucovid19$DateRep)
```

### Últimos 10 dias para alguns países: `r format(ultimadata, '%d-%m-%Y')`


```{r}
filter(jhucovid19, Country == "France") %>% select(-Country, -Continent) %>% top_n(10,DateRep) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>% 
  datatable(rownames = F, autoHideNavigation = T, caption = "França", options = list(paging = FALSE, searching = FALSE))
#  kable(caption = "França")
```


```{r}
filter(jhucovid19, Country == "Italy") %>% select(-Country, -Continent) %>% top_n(10,DateRep) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
  datatable(rownames = F, autoHideNavigation = T ,caption = "Itália", options = list(paging = FALSE, searching = FALSE))
```

```{r}
filter(jhucovid19, Country == "Spain") %>% select(-Country, -Continent) %>% top_n(10,DateRep) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
  datatable(rownames = F, autoHideNavigation = T , caption = "Espanha", options = list(paging = FALSE, searching = FALSE))
```

```{r}
filter(jhucovid19, Country == "Brazil") %>% select(-Country, -Continent) %>% top_n(10,DateRep) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
  datatable(rownames = F, autoHideNavigation = T , caption = "Brasil", options = list(paging = FALSE, searching = FALSE))
```


Para poder estudar o crescimento do número de casos e de mortes, foi adicionada uma coluna com o número de casos de um dia para o outro, já que a base de dados reporta o total de casos em cada dia e não quantos casos foram registrados naquele dia.

```{r}
jhucovid19 <- group_by(jhucovid19, Country) %>% 
  arrange(DateRep) %>%
  mutate(NewDeaths = Deaths - lag(Deaths), 
         NewCases = ConfirmedCases - lag(ConfirmedCases),
         NewCases = if_else(is.na(NewCases), 0, if_else(NewCases < 0, 0, NewCases)),
         NewDeaths = if_else(is.na(NewDeaths), 0, if_else(NewDeaths < 0, 0, NewDeaths))
         ) %>%
  ungroup()
```

### Lista de países com mais de 500 casos, ordenados por número de casos confirmados: `r format(ultimadata, '%d-%m-%Y')` {#JHUpaises}

```{r}
group_by(jhucovid19, Country) %>% 
  summarise(ConfirmedCases = last(ConfirmedCases), Deaths = last(Deaths), Recuperados = last(Recovered)) %>% 
  arrange(desc(ConfirmedCases)) -> listaNumCasos
top5 <- listaNumCasos %>% arrange(desc(ConfirmedCases)) %>% top_n(5, ConfirmedCases) %>% select(Country) %>% unlist()
top15 <- listaNumCasos %>% arrange(desc(ConfirmedCases)) %>% top_n(15, ConfirmedCases) %>% select(Country) %>% unlist()
datatable(filter(listaNumCasos,ConfirmedCases >= 500), rownames = F, autoHideNavigation = T, colnames = c("País", "Casos","Mortes","Recuperados") )

#  kable(filter(listaNumCasos,ConfirmedCases >= 500),col.names = c("País", "Casos","Mortes","Recuperados"))
```


### Alguns gráficos exploratórios com a base do JHU {#GRJHU}


```{r}
filter(jhucovid19, Country %in% top5, DateRep >= ymd("2020-02-01")) %>% 
  ggplot(aes(x = DateRep, y = NewCases)) + geom_bar(aes(fill=Country),stat="identity", position="dodge") +
  labs(x = "", y = "Novos Casos/dia", title = "Novos Casos a partir de 01 de Fev 2020", 
       caption = Fonte, fill="") + scale_fill_brewer(palette =  "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1))
 #-> g
#fig <- ggplotly(g)
#fig
```



```{r eval = FALSE}
filter(jhucovid19,  grepl("China",Country)) %>% kable() #%>% summarise(sum(ConfirmedCases))
```

<!--
Este trecho calcula a diferença que obtenho ao somar os "NewCases" em relação ao total de casos confirmados ("ConfirmedCases"). Não consegui identificar a origem da diferença; uma possibilidade é que a base não começa com o primeiro caso da China, mas em 22 de Janeiro, já com 547 casos confirmados. Ou seja, precisaria fazer mais alguns ajustes nesta variával `NewCases` para, quando acumulada, chegasse ao valor dos `ConfirmedCases` do último dia da base.
-->

```{r eval = FALSE}
jhucovid19 %>% group_by(Country) %>% summarise(Confirmed1 = sum(NewCases) - sum(NewDeaths, na.rm=T), Confirmed2 = last(ConfirmedCases), Diferenca = Confirmed2 - Confirmed1) %>% arrange(desc(Confirmed1)) %>% kable()
```


```{r eval = FALSE}
jhucovid19 %>% filter(Country == "Italy") %>% top_n(10, DateRep)
```


```{r}
filter(jhucovid19, DateRep > "2020-02-01") %>% 
  filter(Continent != "Outro") %>%
  group_by(Continent, DateRep) %>% 
  summarise(numCasos = sum(ConfirmedCases)) %>% 
  ggplot(aes(x = DateRep, y = numCasos)) + 
  geom_bar(aes(fill=Continent),stat="identity", position = "dodge") + 
  labs(x = "", y = "Número Total de Casos",  title = "Total de Casos nos Continentes", subtitle = "a partir de 01/02/2020",
       caption = Fonte, fill="") + 
  scale_fill_brewer(palette = "Set1")  + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1))#-> g
#fig <- ggplotly(g)
#fig
```


```{r}
Italia14 <- filter(jhucovid19, Country == "Italy") %>% 
  filter(ConfirmedCases >= 1 ) %>%  
  select(Country,DateRep, ConfirmedCases,Deaths) 
Brasil13 <- filter(jhucovid19, Country == "Brazil") %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths)
```
```{r}
Italia14 <- mutate(Italia14, Dia = as.numeric(rownames(Italia14))) %>%
  top_n(-25, Dia)
Brasil13 <- mutate(Brasil13, Dia = as.numeric(rownames(Brasil13))) %>%
  top_n(-25, Dia)
```

```{r  eval = FALSE}
Italia14 %>% kable()
```
```{r eval = FALSE}
Brasil13 %>% kable()
```

```{r}
bind_rows(Italia14,Brasil13) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(color = Country, shape = Country), size = 2) + 
  labs(y = "Número de Casos", x = "Dias decorridos", color = "", 
       title = "Evolução dos 25 primeiros dias após o 1º caso", caption = Fonte) + 
  guides(shape = FALSE) + scale_color_discrete(l = 40,c = 150) + labs_pubr() 
  
```

```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "United States")) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-55, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country), size = 1.5) + 
  labs(y = "Número de Casos", x = "Dias Decorridos", shape = "", color= "", 
       title = "Evolução dos 55 primeiros dias após o 1º caso", caption = Fonte)  + 
  scale_color_discrete(l = 40,c = 150) + labs_pubr() 
```

```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "United States")) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 14 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-35, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + 
  geom_point(aes(shape = Country, color = Country), size = 1.5) + 
  labs(y = "Número de Casos", x = "Dias Decorridos", shape = "", 
       color= "", title = "Evolução dos 35 primeiros dias após o 14º caso", caption = Fonte)  + 
  scale_color_discrete(l = 40,c = 150) + labs_pubr() 
```

```{r}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "United States", "Japan")) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  mutate(Dia = row_number()) %>%
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country), size = 1.5) + 
  labs(y = "Número de Casos", x = "Dias Decorridos", shape = "", color= "", 
       title = "Evolução após o 30º caso", caption = Fonte)  + 
  scale_color_discrete(l = 40,c = 150) + labs_pubr()
```

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "United States", "Chile")) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  group_by(DateRep,Country) %>% summarise(ConfCases = sum(ConfirmedCases)) %>% ungroup() %>%
  pivot_wider(id_cols =  DateRep, names_from = Country, values_from = ConfCases) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
  datatable(rownames = F, autoHideNavigation = T, caption = "Evolução dos casos após o 30º caso confirmado" , options = list( searching = FALSE) )
#  kable(caption = "Evolução dos casos após o 30º caso confirmado")
```



### Calculando a taxa de progressão dia-a-dia: Brasil, Itália, China, USA, França, Alemanha, Espanha {#TXJHUtops}

Seguindo a ideia apresentada neste vídeo [Te Explico POR QUÉ estoy PREOCUPADO](https://youtu.be/-PUT0hZiZEw), calculei a taxa de evolução (*chamado de 'factor' no vídeo*)
A taxa de evolução representada aqui é dada por $$TxEv = \frac{NumCasos_i - NumCasos_{i-1}}{NumCasos_{i-1}} + 1$$ É uma maneira simples de representar o acréscimo proporcional de um dia para outro.

```{r}
nma = 5
```



```{r tidy.opts=list(options(knitr.kable.NA = ''))}
jhucovid19 %<>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1) %>% 
  arrange(DateRep) %>%
  mutate(ProgRateDeaths = (Deaths - lag(Deaths))/lag(Deaths), 
         ProgRateCases = (ConfirmedCases - lag(ConfirmedCases))/lag(ConfirmedCases),
         ProgRateDeaths = ProgRateDeaths + 1,
         ProgRateCases = ProgRateCases + 1
         ) 
setDT(jhucovid19)
setkey(jhucovid19,DateRep,Country)
jhucovid19[,NewCasesMA:=as.numeric(frollmean(NewCases,n=nma, align='right',hasNA=TRUE)), by=Country]
jhucovid19[,ProgRateCasesMA:=as.numeric(frollmean(ProgRateCases,n=nma, align='right',hasNA=TRUE)), by=Country]
jhucovid19 <- as_tibble(jhucovid19)

txprogtops <- filter(jhucovid19, Country %in% c("Italy", "Brazil", "France", "Spain", "Germany", "Japan","United States","China"))
txprogtops %>% filter(DateRep >= ymd("2020-03-01")) %>% mutate(DateRep = format(DateRep,"%Y-%m-%d"), ProgRateCases = format(ProgRateCases, digits = 3)) %>% 
select(Country,DateRep,ProgRateCases) %>%
  pivot_wider(names_from = Country, values_from = ProgRateCases) %>% 
  datatable(rownames = F, autoHideNavigation = T, caption = "Evolução dos casos após o 30º caso confirmado", options = list( searching = FALSE))
```


```{r plota2gr}
plt2gr <- function(df, pais) {
  df %>%
  select(Country,DateRep,NewCases,ConfirmedCases, ProgRateCases) %>%
  filter(Country == pais) %>%
  mutate(DateRep = as.Date(DateRep)) %>%
  ggplot(aes(x = DateRep)) +
  geom_bar(aes(y = NewCases),stat = "identity", fill = "red") +
  labs(x = "",y = "Novos Casos")  +
  scale_x_date(date_breaks = "7 days") +
  theme(axis.text.x = element_blank()) -> g1
  df  %>% 
  select(Country,DateRep,NewCases,ConfirmedCases, ProgRateCases) %>%
  filter(Country == pais) %>%
  mutate(DateRep = as.Date(DateRep)) %>%
  ggplot(aes(x = DateRep)) +
  geom_point(aes(y = ProgRateCases), color  = "blue") +
  geom_smooth(aes(y = ProgRateCases), se = FALSE, span = 0.12) +
  labs(x = "",y = "Taxa Evolução",caption = Fonte)   +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) -> g2
figura <- ggarrange(g1,g2,ncol = 1,nrow = 2,align = "v")
annotate_figure(figura, text_grob(paste0("Número de Novos Casos e Taxa de Evolução - ", pais)))
}
```

``` {r}
dtxtops <- txprogtops %>%
  filter(DateRep >= ymd("2020-03-01")) %>%
  select(Country,DateRep,ConfirmedCases, ProgRateCases) 
```  
```{r}
txprogtops %>%
  filter(DateRep >= ymd("2020-03-01")) %>%
  select(Country,DateRep,ConfirmedCases, ProgRateCases) %>%
  mutate(DateRep = as.Date(DateRep)) %>%
  ggplot(aes(x = DateRep, y = ProgRateCases)) +  
  geom_point(aes(color = Country, linetype = Country)) + 
  geom_smooth(aes(color = Country), se = FALSE, span = 0.15) +
  labs(color="", x = "", y = "Taxa de Evolução", title = "Taxa de Evolução", caption = Fonte) + 
  guides(shape = "none", linetype="none") + 
  scale_color_brewer(palette = "Set1") +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) -> gtx
gtx
```


### Gráficos individuais por países: Taxa de evolução e número de novos casos {#TXindJHUtops}

```{r}
plt2gr(txprogtops, "Brazil")
```


```{r}
plt2gr(txprogtops, "United States")
```


```{r}
plt2gr(txprogtops, "Italy")
```

```{r}
plt2gr(txprogtops, "Germany")
```

```{r}
plt2gr(txprogtops, "France")
```

```{r}
plt2gr(txprogtops, "Spain")
```




```{r}
jhucovid19 %>% 
  filter(Continent != "Outro",  DateRep >= "2020-01-15") %>%
  group_by(Country) %>%
 filter(Country %in% top15) %>% 
  arrange(desc(ConfirmedCases)) %>% 
  select(Country,DateRep,ConfirmedCases, Continent) %>%
 arrange(DateRep) %>% mutate(DateRep = format(DateRep, "%Y-%m-%d")) -> dfjhu

#dfjhu_w <- dfjhu %>% arrange(DateRep) %>% mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
#  pivot_wider(id_cols = DateRep, names_from = Country, values_from = ConfirmedCases)
p <- dfjhu %>% group_by(Country) %>% arrange(desc(ConfirmedCases)) %>% summarise(ConfirmedCases = max(ConfirmedCases)) %>%
  ggplot(aes(x = reorder(Country,ConfirmedCases))) +
  geom_bar(aes(y = ConfirmedCases/1000),fill = "tomato2", stat = "identity", position = "dodge") + 
  labs(x = "", y = "Casos Confirmados", title = paste0("15 países com mais casos em ", format(today(), "%d-%m-%Y"))) +
  scale_y_continuous(label = label_number(suffix = "K")) +
    coord_flip() 

p
```

```{r eval = FALSE}
# não vou processar esta animação porque demora muito.
p <- dfjhu %>% 
  ggplot(aes(x = reorder(Country,ConfirmedCases))) +
  geom_bar(aes(y = ConfirmedCases/1000,  frame=DateRep),fill = "orange", stat = "identity", position = "dodge") + 
  scale_y_continuous(label = label_number(suffix = "K")) + 
  geom_text(aes(label= DateRep, x = 2, y = 450), color="black", size=3) +
    coord_flip() 

p <- p + transition_states(DateRep) + labs_pubr() + labs(x = "Países", y = "Casos Confirmados") + theme_pubr() +  
ggtitle('Evolução Casos Confirmados', subtitle = 'Países com mais de 5000 casos') +  ease_aes('linear') 
animate(p, fps = 25,nframes = 400, rewind = FALSE)

```



```{r eval = FALSE}
# Um gráfico experimental com o `plotly`. Aperte o _play_ para ver a animação com os 15 países com mais casos.
fig <- dfjhu %>%
  plot_ly(
    y = ~Country, 
    x = ~ConfirmedCases, 
    color = "red", 
    frame = ~DateRep, 
    text = ~ConfirmedCases, 
    hoverinfo = "text",
    type = 'bar',
    mode = 'markers'
  ) %>% hide_legend() %>% animation_opts(frame = 1000) %>%
  layout(xaxis = list(title = "Confirmed Cases"), yaxis = list(title = ""))

fig
```


### Casos confirmados _vs_  Novos Casos  {#ConfvsCasos}


O gráfico abaixo é interessante para ver que os comportamentos são muito parecidos. Usei uma média móvel de `r nma` observações.

```{r mediamovel}
setDT(txprogtops)
setkey(txprogtops,DateRep,Country)
txprogtops[,NewCasesMA:=as.numeric(frollmean(NewCases,n=nma, align='right',hasNA=TRUE)), by=Country]
txprogtops[,ProgRateCasesMA:=as.numeric(frollmean(ProgRateCases,n=nma, align='right',hasNA=TRUE)), by=Country]
txprogtops <- as_tibble(txprogtops)
```


```{r grmediamovel}
txprogtops %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  filter(Country %in% c("United States", "Spain","Italy","Germany")) %>%
  select(Country,NewCasesMA,ConfirmedCases,Dia) %>%
    ggplot(aes(x = ConfirmedCases/1000, y = NewCasesMA/1000)) +
    geom_line(aes(color = Country), size = 1.5) + 
    labs(x = "Casos Confirmados", y = "Novos Casos", title = "Casos Novos x Confirmados", subtitle = glue::glue("Média Móvel (n=",nma,")"), color ="", caption = Fonte)  + labs_pubr() +
    scale_color_discrete(l = 40,c = 150)  + scale_x_continuous(label = label_number(suffix = "K")) +
   scale_y_continuous(label = label_number(suffix = "K"))
```

Agora apenas com os países com comportamentos mais parecidos: Itália, Espanha, Alemanha

```{r}
txprogtops %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  filter(Country %in% c("Spain","Italy","Germany")) %>%
  select(Country,NewCasesMA,ConfirmedCases,Dia) %>%
    ggplot(aes(x = ConfirmedCases, y = NewCasesMA)) +
    geom_line(aes(color = Country), size = 1.5) + 
    labs(x = "Casos Confirmados", y = "Novos Casos", title = "Casos Novos x Confirmados", subtitle = glue::glue("Média Móvel (n=",nma,")"), color ="", caption = Fonte)  +
    scale_color_discrete(l = 40,c = 150)  + theme(legend.position = "top") + labs_pubr() +
  scale_x_continuous(label = label_number(scale = 0.001, accuracy = 1, suffix = "K")) -> g1
g1
```




```{r}
txprogtops %>%
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  filter(Country %in% c("Spain","Italy","Germany")) %>%
  mutate(DateRep = as.Date(DateRep)) %>% 
  select(Country,DateRep,ConfirmedCases, ProgRateCasesMA) %>%
  ggplot(aes(x = DateRep, y = ProgRateCasesMA)) +  
  geom_point(aes(color = Country, linetype = Country)) + 
  geom_smooth(aes(color = Country), se = FALSE, span = 0.15) +
  labs(color="", x = "", y = "Taxa de Evolução", title = "Taxa de Evolução", 
       subtitle = glue::glue("Média Móvel (n=",nma,")"), caption = Fonte) + 
  guides(shape = "none", linetype="none") + 
  scale_color_brewer(palette = "Set1") + theme(legend.position = "top") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) -> g2
g2
```

```{r}
g12 <- ggarrange(g1,g2,ncol = 2, nrow = 1)
g12
```


### Casos Confirmados _vs_  Número de dias decorridos após 100º caso

Para colocar todos os países no mesmo gráfico, é necessário utilizar uma escala *log*, que comprime a amplitude dos dados, permitindo melhor visualização do comportamento geral.

```{r}
n <- filter(jhucovid19,ConfirmedCases >= 100) %>% dim()
DobroG <- c()
DobroG[1] <- 100
QuintG <- c()
QuintG[1] <- 100
n <- n[1]
for (d in 2:n) {
    DobroG[d] <- DobroG[d-1]*sqrt(2)
    QuintG[d] <- QuintG[d-1]*2**(1/5)
}
yD = 0.7*max(DobroG)
yQ = 0.7*max(QuintG)
```


```{r grconfdias}
jhucovid19 %>% 
  filter(ConfirmedCases >= 100 ) %>% 
  group_by(Country) %>%
  mutate(Dia = row_number(), Dobro = DobroG[row_number()], Dobra5d = QuintG[row_number()]) %>%
  filter(Country %in% c("United States", "Spain","Italy","Germany","France","Turkey")) %>%
  select(Country,ConfirmedCases,Dia, Dobro, Dobra5d) %>%
    ggplot(aes(x = Dia, y = ConfirmedCases)) +
    geom_line(aes(color = Country), size = 1) + 
    geom_line(aes(y = Dobro), linetype = 2, size = 0.2) +
    geom_line(aes(y = Dobra5d), linetype = 2, size = 0.2) +
    labs(x = "Dias decorridos", y = "Casos Confirmados", title = "Casos Confirmados após 100º caso",  color ="", caption = Fonte)  + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +  expand_limits(y = 10) +
  theme(legend.position =  "none") + annotate("text", x = 34, y = 10**8, label = "Dobra 2 dias") +
  annotate("text", x = 40, y = 10**3.7, label = "Dobra 5 dias") + labs_pubr() +
    scale_color_discrete(l = 40,c = 150) + theme(legend.position = "right") 
```


```{r}
paisestop <- listaNumCasos %>% filter(Country != "China") %>% 
  top_n(5,ConfirmedCases) %>%
  select(Country) %>% unlist()
```





## Países com números de casos semelhantes ao Brasil em 25/03/2020 {#JHUBRparecidos}

```{r}
dadosBR <- filter(jhucovid19, Country == "Brazil", DateRep == ymd("2020-03-25")) %>% select(ConfirmedCases) %>% as.numeric()
```

Em 25 de Março de 2020, os países abaixo tinham número de casos próximos entre si; estabeleci uma faixa, variando de `r dadosBR - 250` a `r dadosBR + 250` e filtrei os países. Adicionei à lista, que estava fora desta faixa, Portugal.


```{r}
dadosparecidos <- filter(jhucovid19, DateRep == ymd("2020-03-25"), ConfirmedCases >= (dadosBR - 250) & ConfirmedCases <= dadosBR + 250) %>% select(Country,ConfirmedCases)
dadosparecidos <- bind_rows(dadosparecidos, filter(jhucovid19, DateRep == ymd("2020-03-25"), Country == "Portugal") %>% select(Country, ConfirmedCases))
kable(dadosparecidos) %>% kable_styling(c("striped", "condensed"), full_width = F)
```

Os gráficos a seguir mostram a evolução dos casos nestes países a partir de pontos diferentes:

* a partir do 1º caso, 55 dias
* a partir do 14º caso, 35 dias
* a partir do 30º caso, até último dado.

```{r}
filter(jhucovid19, Country %in% unlist(dadosparecidos$Country)) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-55, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country), size = 1.5) + 
  labs(y = "Número de Casos", x = "Dias Decorridos", shape = "", color= "", 
       title = "Evolução dos 55 primeiros dias após o 1º caso", caption = Fonte) + 
  scale_y_continuous(label = label_number(scale = 0.001, accuracy = 1, suffix = "K")) +
  scale_color_discrete(l = 40,c = 150) + labs_pubr()
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% unlist(dadosparecidos$Country)) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 14 ) %>% 
  mutate(Dia = row_number()) %>%
  top_n(-35, Dia) %>% 
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country), size = 1.5) + 
  labs(y = "Número de Casos", x = "Dias Decorridos", shape = "", color= "", 
       title = "Evolução dos 35 primeiros dias após o 14º caso", caption = Fonte)  + 
  scale_color_discrete(l = 40,c = 150) +
  scale_y_continuous(label = label_number(scale = 0.001, accuracy = 1, suffix = "K")) + labs_pubr()
#fig <- ggplotly(g)
#fig
```

```{r}
filter(jhucovid19, Country %in% unlist(dadosparecidos$Country)) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  select(Country,DateRep,ConfirmedCases,Deaths) %>% 
  group_by(Country) %>% 
  mutate(Dia = row_number()) %>%
  ggplot(aes(x = Dia, y = ConfirmedCases)) + geom_point(aes(shape = Country, color = Country),size = 1.5) + 
  labs(y = "Número de Casos", x = "Núm Dias após o 30º caso", shape = "", color= "", 
       title = "Evolução após o 30º caso", caption = Fonte)  + 
  scale_color_discrete(l = 40,c = 150) +
  scale_y_continuous(label = label_number(scale = 0.001, accuracy = 1, suffix = "K")) + labs_pubr()
#fig <- ggplotly(g)
#fig
```

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% unlist(dadosparecidos$Country)) %>% 
  filter(ConfirmedCases >= 30 ) %>% 
  group_by(DateRep,Country) %>% summarise(ConfCases = sum(ConfirmedCases)) %>% ungroup() %>%
  pivot_wider(id_cols =  DateRep, names_from = Country, values_from = ConfCases) %>% 
   mutate(DateRep = format(DateRep, "%d-%m-%Y")) %>%
  datatable(rownames = F, autoHideNavigation = T, caption = "Evolução dos casos após o 30º caso confirmado", options = list( searching = FALSE)) 
```


#### Calculando a taxa de progressão dia-a-dia: Brazil, Portugal, Sweden, Turkey, Israel, Australia {#JHUTXProgparec}

```{r tidy.opts=list(options(knitr.kable.NA = ''))}
filter(jhucovid19, Country %in% unlist(dadosparecidos$Country)) %>% 
  group_by(Country) %>% 
  filter(ConfirmedCases >= 1) %>% 
  arrange(DateRep) %>%
  mutate(ProgRateDeaths = (Deaths - lag(Deaths))/lag(Deaths), 
         ProgRateCases = (ConfirmedCases - lag(ConfirmedCases))/lag(ConfirmedCases),
         ProgRateDeaths = ProgRateDeaths + 1,
         ProgRateCases = ProgRateCases + 1
         ) -> txprogpar
txprogpar %>%  
  filter(DateRep >= ymd("2020-03-01")) %>% 
  mutate(DateRep = format(DateRep,"%Y-%m-%d"), ProgRateCases = format(ProgRateCases, digits = 3)) %>%
  select(Country,DateRep,ProgRateCases) %>%
  pivot_wider(names_from = Country, values_from = ProgRateCases) %>% 
  datatable(rownames = F, autoHideNavigation = T, caption = "Taxa de Progressão", options = list( searching = FALSE)) 
```

<pre>

</pre>

```{r}
txprogpar %>%
  filter(DateRep >= ymd("2020-03-01")) %>%
  select(Country,DateRep,ConfirmedCases, ProgRateCases) %>%
  mutate(DateRep = as.Date(DateRep)) -> dg
ggplot(data = dg, aes(x = DateRep, y = ProgRateCases)) +  
  geom_point(aes(color = Country, linetype = Country)) + 
  geom_smooth(aes(color = Country), se = FALSE, span = 0.15) +
  labs(color="", x = "", y = "Taxa de Evolução", caption = Fonte, title = "Taxa de Evolução") + 
  guides(shape = "none", linetype="none") + 
  scale_color_brewer(palette = "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) 
```




```{r}
jhucovid19 %>% 
  filter(ConfirmedCases >= 100 ) %>% 
  group_by(Country) %>%
  mutate(Dia = row_number(), Dobro = DobroG[row_number()], Dobra5d = QuintG[row_number()]) %>%
  filter(Country %in% c("Australia", "Brazil","Israel","Portugal","Sweden","Turkey")) %>%
  select(Country,ConfirmedCases,Dia, Dobro, Dobra5d) %>%
    ggplot(aes(x = Dia, y = ConfirmedCases)) +
    geom_line(aes(color = Country), size = 1) + 
    geom_line(aes(y = Dobro), linetype = 2, size = 0.2) +
    geom_line(aes(y = Dobra5d), linetype = 2, size = 0.2) +
    labs(x = "Dias decorridos", y = "Casos Confirmados", title = "Casos Confirmados após 100º caso",  color ="", caption = Fonte)  + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +  expand_limits(x = c(0,35), y = 10) +
  theme(legend.position =  "none") + annotate("text", x = 24, y = 10**6.3, label = "Dobra 2 dias") +
  annotate("text", x = 30, y = 10**3, label = "Dobra 5 dias") +
    scale_color_discrete(l = 40,c = 150) +  theme(legend.position = "right")  + labs_pubr() 
```


```{r}
jhucovid19 %>% 
  filter(ConfirmedCases >= 100 ) %>% 
  group_by(Country) %>%
  mutate(Dia = row_number(), Dobro = DobroG[row_number()], Dobra5d = QuintG[row_number()]) %>%
  filter(Country %in% c( "Brazil","Israel","Portugal")) %>%
  select(Country,ConfirmedCases,Dia, Dobro, Dobra5d) %>%
    ggplot(aes(x = Dia, y = ConfirmedCases)) +
    geom_line(aes(color = Country), size = 1) + 
    geom_line(aes(y = Dobro), linetype = 2, size = 0.2) +
    geom_line(aes(y = Dobra5d), linetype = 2, size = 0.2) +
    labs(x = "Dias decorridos", y = "Casos Confirmados", title = "Casos Confirmados após 100º caso",  color ="", caption = Fonte)  + scale_y_log10(breaks = trans_breaks("log10", function(x) 10^x),
              labels = trans_format("log10", math_format(10^.x))) +  expand_limits(x = c(0,35), y = 10) +
  theme(legend.position =  "none") + annotate("text", x = 24, y = 10**6.3, label = "Dobra 2 dias") +
  annotate("text", x = 30, y = 10**3, label = "Dobra 5 dias") + labs_pubr() +
    scale_color_discrete(l = 40,c = 150)  + theme(legend.position = "right") 
```


### Gráficos individuais dos países semelhantes ao Brasil: Taxa de evolução e número de novos casos {#TXindParecid}

```{r}
plt2gr(txprogpar, "Brazil")
```

```{r}
plt2gr(txprogpar, "Australia")
```

```{r}
plt2gr(txprogpar, "Portugal")
```

```{r}
plt2gr(txprogpar, "Turkey")
```

```{r}
plt2gr(txprogpar, "Sweden")
```

```{r}
plt2gr(txprogpar, "Israel")
```

# Base de dados do Worldometer {#Worldometer}

Esta base de dados tem uma atualização bem interessante, com algumas variáveis também interessantes.

Ela está disponível em `https://www.worldometers.info/coronavirus/`

O problema é que não achei nenhum `csv` ou `xlsx` para baixar; então vou a solução é fazer um _web scraping_ e pegar os dados. Utilizando o pacote `rvest` e seguindo a dica [deste post](https://www.r-bloggers.com/using-rvest-to-scrape-an-html-table/) foi razoavelmente fácil. 



```{r}
url <- "https://www.worldometers.info/coronavirus/"
coronaworldometer <- url %>%
  html() %>%
  html_nodes(xpath='//*[@id="main_table_countries_today"]') %>% 
  html_table()
```
```{r}
womcovid19 <- coronaworldometer[[1]]
```

Olhando a estrutura destes dados:

```{r eval = FALSE}
str(womcovid19)
```

Depois de pegar a tabela em html e colocar em um `data.frame`, algumas limpezas e transformações são necessárias: algumas colunas, como a `NewCases`, tem o símbolo `+`; os números vieram formatados como _strings_ com separador de milhar (`,`), e algumas outras coisas. Então, algumas manipulações serão feitas para acertar isso.

```{r}
head(womcovid19) %>% select(`Country,Other`,TotalCases,NewCases,TotalDeaths,NewDeaths) %>% kable() %>% kable_styling(c("striped"), full_width = F)
```

```{r eval = FALSE}
# quando vi que colocaram uma linha World também
womcovid19 %>% top_n(20, `Country,Other`)
```


```{r}
womcovid19 <- womcovid19 %>% 
  rename(Country = `Country,Other`, SeriousCritical = `Serious,Critical`) %>% 
  rename(Cases1M = contains("Cases/1M pop"), Deaths1M = contains("Deaths/1M pop")) %>% 
  mutate_at(vars(TotalCases,NewCases,TotalDeaths,NewDeaths,TotalRecovered,ActiveCases,SeriousCritical,Cases1M, Deaths1M), str_remove ,"," )  %>%
  mutate_at(vars(NewCases,NewDeaths), str_remove , "\\+" ) %>%
  mutate_at(vars(TotalCases,NewCases,TotalDeaths,NewDeaths,TotalRecovered,ActiveCases,SeriousCritical,Cases1M, Deaths1M), as.numeric, na.rm=TRUE) %>% 
  filter(Country != "Total:")
```

```{r}
hoje <- today()
```


### Total de Casos pelos dados do Worldometer: `r format(hoje, '%d-%m-%Y')` {#WorldometerTot}

<!-- Europe North America Asia South America Africa Oceania  -->

O Worldometer não contabiliza os casos do _Diamond Princess_ ou contabiliza juntamente com algum país, ou países (da nacionalidade de cada pessoa). Então, estou retirando também para refletir o valor mostrado no site do Worldometer.

O Worldometer também passou a apresentar totais de alguns continentes ou regiões; como não está padronizado, ou seja, não estão agrupando por continentes, que seria fácil remover na filtragem; ao invés disso, colocaram por exemplo, _North America_ e _South America_, mas não tem _Americas_. Depois do dia 09 ou 10 de abril, o Worldometer passou a incluir uma linha *World* na tabela.Assim, estou removendo de acordo com o que eles mudam no site.

```{r}
womcovid19 %>%
  filter(!Country %in% c("Europe", "Asia", "North America", "South America", "Africa", "Oceania", "Diamond Princess", "World")) %>%
  select(TotalCases, TotalDeaths, TotalRecovered) %>% 
  dplyr::summarise(TotalCasos = sum(TotalCases,na.rm = T), TotalMortes=sum(TotalDeaths,na.rm = T), TotalRecuperados = sum(TotalRecovered,na.rm = T)) %>%
  kable() 
```


### Lista de países com mais de 500 casos, ordenados por número de casos confirmados: `r format(hoje, '%d-%m-%Y')` {#WorldometerPaises}

Conforme explicado acima, o Worldometer passou a incluir totalizações por continentes e regiões. Vou manter na listagem para facilitar a comparação dos valores.

```{r}
womcovid19 %>% 
  select(Country, TotalCases, TotalDeaths, TotalRecovered) %>% 
  arrange(desc(TotalCases)) %>% filter(TotalCases >= 500) %>%
  datatable(rownames = F, autoHideNavigation = T) 
```


# Dados do Kaggle - Coronavirus - Brazil {#DadosBrasilKaggle}

```{r}
brcovid19 <- read_csv("./data/brazil_covid19.csv", col_types = cols(date = col_date(format = "%Y-%m-%d")))
```


```{r}
Fonte = "Raphael Fontes (Kaggle)"
```

```{r eval = FALSE}
str(brcovid19)
```

```{r}
brcovid19 <- brcovid19 %>% rename(Data = date, Casos = cases, Mortes = deaths, Regiao = region, Estado = state)
```

```{r}
ultimadata <- max(brcovid19$Data)
```


### Total de Casos pelos dados do Kaggle Brazil: `r format(ultimadata, '%d-%m-%Y')` {#BRtotKagg}
 
```{r}
brcovid19 %>% 
  arrange(Data) %>%
  group_by(Estado) %>% 
  summarise(TotEstado = last(Casos), MortesEstado = last(Mortes)) %>%
  summarise(`Casos Confirmados` = sum(TotEstado), `Total Mortes`= sum(MortesEstado), `Letalidade`= sprintf("%s%%",round(sum(MortesEstado)/sum(TotEstado)*100,1))) -> brtotais
  kable(brtotais, align = "r") 
```

Incorporando a estimativa da população brasileira com os dados do IBGE, publicados em Janeiro de 2020, conforme esta página: [IBGE - Estimativas População, enviada ao TCU](https://www.ibge.gov.br/estatisticas/sociais/populacao/9103-estimativas-de-populacao.html?=&t=resultados)

```{r}
brpopestados <- read_csv("./data/estimativa_populacao_Estados_TCU_2019_20200116.csv")
```

```{r}
brcovid19 <- left_join(brcovid19, brpopestados[,c(1,2)], by = "Estado")
```

```{r brcovid}
brcovid19 %>% group_by(Data) %>% summarise(CasosTot = sum(Casos), MortesTot = sum(Mortes)) %>%
filter(CasosTot > 0) %>% 
  gather(key = "Ocorrencia", value = "Valor", CasosTot:MortesTot) %>% 
  mutate(Data = as.Date(Data)) %>% 
  ggplot(aes(x = Data, y = Valor, fill = Ocorrencia)) + 
  geom_bar(stat="identity", position = "dodge") +
  labs(x = "", y = "Casos", title="Número de Casos Reportados diariamente no Brasil", 
       subtitle = glue::glue("Casos: ",brtotais$`Casos Confirmados`, " - Mortes: ", brtotais$`Total Mortes`),
       caption = Fonte, fill ="", y = "") + 
  scale_fill_brewer(palette = "Set1") + labs_pubr() +
  scale_x_date(date_labels = "%b %d", date_breaks = "7 days") +
  scale_y_continuous(label = label_number(scale = 0.001, accuracy = 1, suffix = "K")) +
  theme(axis.text.x = element_text(angle=45, hjust = 1)) 
```


```{r brcovidest, eval = FALSE}
brcovid19 %>% 
  arrange(Data) %>% 
  group_by(Estado) %>% summarise(CasosTot = last(Casos), MortesTot = last(Mortes)) %>%
  gather(key = "Ocorrência", value = "Valor", CasosTot:MortesTot) %>% arrange(Estado) %>%
  ggplot(aes(x = reorder(Estado,Valor), y = Valor, fill = Ocorrência)) + 
  geom_bar(stat="identity", position = position_dodge()) +
  geom_text(aes(x = Estado, y = Valor, label = Valor), hjust = -0.5, size = 3, color = "darkblue") +
  labs(x = "", title="Número de Casos e Mortes por Estado", 
       caption = Fonte, fill ="", y = "") + 
  scale_fill_brewer(palette = "Set1")  + labs_pubr() + 
  theme(legend.position = "top",
        plot.background = element_rect(fill = "#DDDDDD"), 
        axis.text.x = element_text(color = "#111111"),
        axis.text.y = element_text(color = "#111111"),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.line.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(), 
        plot.title = element_text(color = "darkblue"), 
        plot.title.position = "panel",
        plot.margin = margin(10,25,15,10)
        ) + 
  coord_flip()
```

```{r}
brcovid19 %>% 
  arrange(Data) %>% 
  group_by(Estado) %>% summarise(CasosTot = last(Casos), MortesTot = last(Mortes), Casos1M = CasosTot/last(População)*1e6, Mortes1M = MortesTot/last(População)*1e6) %>% 
  mutate(Casos1M = round(Casos1M,1), Mortes1M = round(Mortes1M,2), Letalidade = MortesTot/CasosTot) %>%
  rename(Casos = CasosTot, Mortes = MortesTot) -> brestados
```





```{r tabelaestados}
brestados %>% mutate(Letalidade = paste0(round(Letalidade*100,1),"%")) %>%
  datatable(rownames = F, autoHideNavigation = T, caption = "Detalhamento Brasil por Estados", options = list( searching = FALSE)) 
```

  
```{r eval = FALSE}
frmtbl <- formattable(brestados, align =c("r", "r", "r"), 
            list(`Estado` = formatter("span", style = ~ style(color = "black", font.weight = "bold")), 
                  area(col = c(2:5))  ~ formatter("span", 
                             style = x ~ style(color ="black", 
                                               font.weight = "bold",
                                               display = "inline-block",
                                               direction = "rtl",
                                               "border-radius" = "4px",
                                               "padding-right" = "2px",
                                               "background-color" = csscolor("#5511FF"),
                                               width = percent(normalize(x), digits = 0),
                                               color = csscolor("black"))),           
  area(col = 3) ~ formatter("span", style = x ~ style(color ="black", 
                                               font.weight = "bold","background-color" = csscolor("#FB113A"),width = percent(normalize(x)))),
  area(col = 4) ~ formatter("span", style = x ~ style(color ="black", 
                                               font.weight = "bold","background-color" = csscolor("#5511FF"),width = percent(normalize(x)))),
  area(col = 5) ~ formatter("span", style = x ~ style(color ="black", 
                                               font.weight = "bold","background-color" = csscolor("#FB113A"),width = percent(normalize(x)))),
#    `Mortes` = proportion_bar("#FB113A", 0.02),
  #`Casos1M` = normalize_bar("#5511FF", 0.02),
  #`Mortes1M` = normalize_bar("#FB113A", 0.02),
  area(col = 6) ~ function(x) percent(x, digits = 1)
 # area(col = 2) ~  normalize_bar("#5511FF", 0.02)
  
))
frmtbl 
```



# Dados do Brasil a partir do Projeto Brasil.io

Descobri em 15/04/2020 este projeto fantástico:  [Brasil.io](https://brasil.io/home)

> **O Brasil em dados libertos**

> Repositório de dados públicos disponibilizados em formato acessível

Dentre as diversas bases de dados que eles disponibilizam, tem uma sobre a COVID-19 em território brasileiro.

Esta é uma primeira utilização, simples, para entender a base. Como esta base contém informações dos municípios brasileiros, penso que será possível explorá-la bastante. 

```{r}
casosfull_brio <- read_csv("./data/caso_full.csv")
```

```{r}
ultimadata <- max(casosfull_brio$date)
```

### Total de Casos pelos dados do Brasil.io: `r format(ultimadata, '%d-%m-%Y')` {#BRtotBRio}
 
```{r}
casosfull_brio %>% 
  arrange(date) %>%
  filter(place_type == "state") %>%
  group_by(state) %>% 
  filter(is_last == "TRUE") %>%
  summarise(TotEstado = last(last_available_confirmed), MortesEstado = last(last_available_deaths)) %>%
  summarise(`Casos Confirmados` = sum(TotEstado), `Total Mortes`= sum(MortesEstado), `Letalidade`= sprintf("%s%%",round(sum(MortesEstado)/sum(TotEstado)*100,1))) -> briototais
  kable(briototais, align = "r") 
```

```{r eval = FALSE}
casosfull_brio %>% 
  filter(place_type == "city") %>% 
  group_by(state) %>% 
  filter(is_last == "TRUE") %>% 
  summarise(Confirmados = sum(last_available_confirmed),Mortes = sum(last_available_deaths)) %>% 
  rename(Estado = state) %>%
  datatable(rownames = F, autoHideNavigation = T, caption = "Detalhamento Brasil por Estados (Brasil.io)", options = list( searching = FALSE)) 
```


```{r eval = FALSE}
str(casosfull_brio,give.attr=FALSE)
```


```{r eval = FALSE}
# para fazer gráfico de barra - abandonei em favor do dotplot, abaixo.
p <- casosfull_brio %>% 
  filter(place_type == "state") %>% 
  group_by(state,date) %>% 
  filter(is_last == "TRUE") %>%
  summarise(Casos = sum(last_available_confirmed), População = last(estimated_population_2019), Mortes = sum(last_available_deaths)) %>%
  ggplot(aes(x = reorder(state,Casos), y = Casos)) + geom_col() + 
  geom_bar(fill = "#666666", stat = "identity", position = "dodge") + 
  #geom_bar_text(position = "dodge", min.size = 2 ) +
  geom_text(aes(x = state, y = Casos, label = Casos), hjust = -0.2, size = 3, color = "darkblue") +
  geom_text(aes(x = state, y = 0, label = state), hjust = 1.5, size = 3.5, color = "darkblue") +
  labs(x = "", y = "", title = paste0("Casos Confirmados em ", format(ultimadata, "%d-%m-%Y"))) +
  scale_y_continuous(breaks = NULL, labels = NULL, expand = expansion(mult = 0.18)) + scale_x_discrete(breaks = NULL) +
  labs_pubr() + 
  theme(plot.background = element_rect(fill = "#DDDDDD"), 
        axis.text.x = element_text(color = "#111111"),
        axis.text.y = element_text(color = "#111111"),
        axis.ticks.y = element_blank(),
        axis.line.y = element_blank(),
        axis.line.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        strip.background = element_blank(), 
        plot.title = element_text(color = "darkblue", hjust = 0.2), 
        plot.title.position = "panel",
        plot.margin = margin(10,35,1,10)
        ) + 
  coord_flip() 

#p

```

```{r}
q <- casosfull_brio %>% 
  filter(place_type == "state") %>% 
  group_by(state,date) %>% 
  filter(is_last == "TRUE") %>%
  summarise(Casos = sum(last_available_confirmed), População = last(estimated_population_2019), Mortes = sum(last_available_deaths)) %>%
  ggplot(aes(x = reorder(state,Casos), y = Mortes)) + geom_point(col = "tomato2", size = 3) + 
  geom_segment(aes(x = state, xend = state, y=0, yend= Mortes), linetype = "solid", size = 0.2) + 
  #geom_bar(fill = "#666666", stat = "identity", position = "dodge") + 
  #geom_bar_text(position = "dodge", min.size = 2 ) +
  geom_text(aes(x = state, y = Mortes, label = Mortes), hjust = -1.2,  size = 3, color = "black") +
 # geom_text(aes(x = state, y = 0, label = state), hjust = 1.5, size = 3.5, color = "darkblue") +
  labs(x = "", y = "", title = paste0("Mortes em ", format(ultimadata, "%d-%m-%Y"))) +
  scale_y_continuous(breaks = NULL, labels = NULL, expand = expand_scale(mult = c(0.015,0.18))) + #scale_x_discrete(breaks = NULL) +
  labs_pubr() +
  theme(#plot.background = element_rect(fill = "#666666"), 
        #axis.text.x = element_text(color = "#111111"),
        #axis.text.y = element_text(color = "#111111"),
        axis.ticks.y = element_blank(),
       # axis.line.y = element_blank(),
        axis.line.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        #panel.border = element_blank(),
        strip.background = element_blank(), 
        #plot.title = element_text(color = "white", hjust = 0.2), 
        plot.title.position = "panel",
        plot.margin = margin(10,5,1,1),
       
        ) + 
  coord_flip() 
#q
#figura2 <-  ggarrange(p,q,ncol = 2)
#figura2
```



```{r}
p <- casosfull_brio %>% 
  filter(place_type == "state") %>% 
  group_by(state,date) %>% 
  filter(is_last == "TRUE") %>%
  summarise(Casos = sum(last_available_confirmed), População = last(estimated_population_2019), Mortes = sum(last_available_deaths)) %>%
  ggplot(aes(x = reorder(state,Casos), y = Casos)) + geom_point(col = "tomato2", size = 3) + 
  #geom_bar(fill = "#666666", stat = "identity", position = "dodge") + 
  #geom_bar_text(position = "dodge", min.size = 2 ) +
  geom_segment(aes(x = state, xend = state, y=0, yend= Casos), linetype = "solid", size = 0.2) + 
  geom_text(aes(x = state, y = Casos, label = Casos), hjust = -0.7, size = 3, color = "black") +
 # geom_text(aes(x = state, y = 0, label = state), hjust = 1.5, size = 3.5, color = "darkblue") +
  labs(x = "", y = "", title = paste0("Casos Confirmados em ", format(ultimadata, "%d-%m-%Y"))) + 
  scale_y_continuous(breaks = NULL, labels = NULL, expand = expand_scale(mult = c(0.015,0.18))) + #scale_x_discrete(breaks = NULL) +
labs_pubr() + 
  theme(#plot.background = element_rect(fill = "#666666"), 
        #axis.text.x = element_text(color = "#111111"),
        #axis.text.y = element_text(color = "#111111"),
        axis.ticks.y = element_blank(),
       # axis.line.y = element_blank(),
        axis.line.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        #panel.border = element_blank(),
        strip.background = element_blank(), 
        #plot.title = element_text(color = "white", hjust = 0.2), 
        plot.title.position = "panel",
        plot.margin = margin(10,5,1,1),
       
        ) + 
  coord_flip() 
#p
```




```{r}
library(cowplot)
```
```{r eval = FALSE}
ggdraw() +
  draw_plot(p, x = 0, y = 0) + draw_plot(q, x = .5, y = 0)
```

```{r}
library(gridExtra)
```

```{r eval = FALSE}
grid.arrange(p, q, ncol = 2)
```


```{r}
library(patchwork)
```

```{r out.width= "\\textwidth",fig.width=10, fig.height=9}
p + q
```




------------


<div><span><a href="https://momenezes.github.io/covid19/"><img src="./back.png" alt="HOME" width="60" style="vertical-align:middle">  <b>HOME  </b> </a></span><span style="color:blue;font-size:8px; padding: 20%;">Página gerada em: "`r format(Sys.time(), '%c')`"</span></div>
